<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Room Dashboard — Halifax</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#e2e8f0;
      --shadow:0 6px 18px rgba(2,6,23,.08);
      --accent:#2563eb;
      --ok:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.70);
      backdrop-filter: blur(8px);
      position:sticky;
      top:0;
      z-index:10;
    }
    .title{font-size:22px;font-weight:800;letter-spacing:-.2px}
    .subtitle{color:var(--muted);font-size:14px;margin-top:4px}
    .clock{font-variant-numeric: tabular-nums;font-size:18px;font-weight:700}
    main{
      padding:18px 22px 26px;
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      grid-template-rows: auto auto auto;
      gap:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      font-weight:800;
      letter-spacing:-.1px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:5px 10px;
      border-radius:999px;
      background:#fff;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
    .span-2{grid-column:1 / -1}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .divider{height:1px;background:var(--border);margin:12px 0}

    /* Weather */
    .weather-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    .temp{
      font-size:54px;
      font-weight:900;
      letter-spacing:-1px;
      line-height:1;
      margin-top:2px;
    }
    .wxline{font-size:14px;color:var(--muted)}
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      font-size:14px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      margin-bottom:8px;
    }
    .kv b{font-variant-numeric: tabular-nums;}
    .forecast{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .fday{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fff;
      min-height:88px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .fday .d{font-weight:800;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
    .fday .t{font-weight:900;font-size:16px}
    .fday .s{font-size:12px;color:var(--muted);line-height:1.2}

    /* News */
    .news-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .newslist{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .newsitem{
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-height:58px;
    }
    .newsitem a{
      color:var(--text);
      text-decoration:none;
      font-weight:800;
      line-height:1.2;
      font-size:14px;
    }
    .newsitem a:hover{ text-decoration:underline; text-decoration-color: rgba(37,99,235,.6); }
    .newsmeta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .dot{width:4px;height:4px;border-radius:999px;background:var(--border);display:inline-block}
    .status{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
    }
    .status.ok{color:var(--ok);border-color:rgba(22,163,74,.25)}
    .status.warn{color:var(--warn);border-color:rgba(217,119,6,.25)}
    .status.bad{color:var(--bad);border-color:rgba(220,38,38,.25)}

    /* TradingView ticker container */
    #tv-ticker{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }

    .foot{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width: 1100px){
      main{grid-template-columns: 1fr}
      .news-cols{grid-template-columns:1fr}
      .forecast{grid-template-columns: repeat(3, 1fr)}
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Room Dashboard</div>
      <div class="subtitle">Halifax, Nova Scotia • Weather • News • Markets</div>
    </div>
    <div class="clock" id="clock">--:--</div>
  </header>

  <main>
    <!-- WEATHER -->
    <section class="card">
      <h2>
        <span>Live Weather — Halifax</span>
        <span class="badge" id="wxUpdated">Updating…</span>
      </h2>

      <div class="weather-grid">
        <div>
          <div class="temp"><span id="temp">--</span>°C</div>
          <div class="wxline" id="wxText">Loading…</div>

          <div class="divider"></div>

          <div class="forecast" id="forecast">
            <!-- filled by JS -->
          </div>

          <div class="foot">Weather data: Open-Meteo (no API key). Updated automatically. </div>
        </div>

        <div>
          <div class="kv"><span>Feels like</span><b><span id="apparent">--</span>°C</b></div>
          <div class="kv"><span>Wind</span><b><span id="wind">--</span> km/h</b></div>
          <div class="kv"><span>Precip (now)</span><b><span id="precip">--</span> mm</b></div>
          <div class="kv"><span>Humidity</span><b><span id="humidity">--</span>%</b></div>
          <div class="kv"><span>Cloud cover</span><b><span id="cloud">--</span>%</b></div>
          <div class="kv"><span>UV index</span><b><span id="uv">--</span></b></div>
        </div>
      </div>
    </section>

    <!-- MARKETS -->
    <section class="card">
      <h2>
        <span>Markets</span>
        <span class="badge">Live ticker</span>
      </h2>

      <div id="tv-ticker"></div>

      <div class="foot">
        Tip: edit the symbols list in the HTML (search for <b>TRADINGVIEW_SYMBOLS</b>) to add/remove tickers.
      </div>
    </section>

    <!-- NEWS -->
    <section class="card span-2">
      <h2 class="row" style="justify-content:space-between">
        <span>Top News</span>
        <span class="row">
          <span class="status" id="newsStatus">Fetching…</span>
          <span class="badge" id="newsUpdated">—</span>
        </span>
      </h2>

      <div class="news-cols">
        <div>
          <div class="row" style="justify-content:space-between;margin-bottom:10px">
            <div style="font-weight:900">Local (Nova Scotia)</div>
            <div class="muted" style="font-size:12px">Nova Scotia government news</div>
          </div>
          <ul class="newslist" id="newsLocal"></ul>
        </div>

        <div>
          <div class="row" style="justify-content:space-between;margin-bottom:10px">
            <div style="font-weight:900">World</div>
            <div class="muted" style="font-size:12px">BBC News RSS</div>
          </div>
          <ul class="newslist" id="newsWorld"></ul>
        </div>
      </div>

      <div class="foot">
        If headlines don’t load on your network, your firewall may block RSS or the CORS proxy. In that case, host a tiny internal RSS-to-JSON endpoint and point this page to it.
      </div>
    </section>
  </main>

  <script>
    /***********************
     * CONFIG
     ***********************/
    // Halifax approx coordinates
    const HALIFAX = { lat: 44.6488, lon: -63.5752, tz: "America/Halifax" };

    // NEWS FEEDS (RSS)
    // Local: Nova Scotia government RSS listing provides official RSS feeds.
    // Pick a feed from their listing; this one is the main "All news releases" feed (URL can be changed if your org prefers another).
    // If you want CBC Nova Scotia instead, replace LOCAL_RSS with a CBC RSS URL.
    const LOCAL_RSS = "https://novascotia.ca/news/rss/";
    const WORLD_RSS = "https://feeds.bbci.co.uk/news/rss.xml?edition=int";

    // CORS proxy for RSS fetch (client-side). If blocked, you’ll need an internal proxy.
    const CORS_RAW = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

    // TradingView symbols (edit these)
    // TRADINGVIEW_SYMBOLS: use TradingView "proName" format or popular tickers.
    const TRADINGVIEW_SYMBOLS = [
      { proName: "SP:SPX", title: "S&P 500" },
      { proName: "NASDAQ:NDX", title: "Nasdaq 100" },
      { proName: "TSX:TSX", title: "TSX" },
      { proName: "NASDAQ:AAPL", title: "Apple" },
      { proName: "NASDAQ:MSFT", title: "Microsoft" },
      { proName: "NYSE:BRK.B", title: "Berkshire" }
    ];

    /***********************
     * CLOCK
     ***********************/
    function tickClock(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      document.getElementById('clock').textContent = `${hh}:${mm}`;
    }
    tickClock(); setInterval(tickClock, 1000);

    /***********************
     * WEATHER (Open-Meteo)
     ***********************/
    function weatherCodeToText(code){
      const map = {
        0:"Clear",
        1:"Mainly clear",
        2:"Partly cloudy",
        3:"Overcast",
        45:"Fog",
        48:"Rime fog",
        51:"Light drizzle",
        53:"Drizzle",
        55:"Heavy drizzle",
        56:"Freezing drizzle",
        57:"Heavy freezing drizzle",
        61:"Light rain",
        63:"Rain",
        65:"Heavy rain",
        66:"Freezing rain",
        67:"Heavy freezing rain",
        71:"Light snow",
        73:"Snow",
        75:"Heavy snow",
        77:"Snow grains",
        80:"Rain showers",
        81:"Showers",
        82:"Violent showers",
        85:"Snow showers",
        86:"Heavy snow showers",
        95:"Thunderstorm",
        96:"Thunderstorm w/ hail",
        99:"Thunderstorm w/ heavy hail"
      };
      return map[code] ?? `Weather (${code})`;
    }

    function dayLabel(isoDate){
      const d = new Date(isoDate + "T00:00:00");
      return d.toLocaleDateString([], { weekday: "short" });
    }

    async function loadWeather(){
      const {lat, lon, tz} = HALIFAX;
      // current + 5-day daily forecast
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,wind_speed_10m,weather_code,cloud_cover,uv_index` +
        `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum` +
        `&timezone=${encodeURIComponent(tz)}`;

      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("Weather fetch failed");
      const data = await res.json();

      const c = data.current;
      document.getElementById('temp').textContent = Math.round(c.temperature_2m);
      document.getElementById('apparent').textContent = Math.round(c.apparent_temperature);
      document.getElementById('wind').textContent = Math.round(c.wind_speed_10m);
      document.getElementById('precip').textContent = (c.precipitation ?? 0).toFixed(1);
      document.getElementById('humidity').textContent = Math.round(c.relative_humidity_2m ?? 0);
      document.getElementById('cloud').textContent = Math.round(c.cloud_cover ?? 0);
      document.getElementById('uv').textContent = (c.uv_index ?? 0).toFixed(1);

      document.getElementById('wxText').textContent = weatherCodeToText(c.weather_code);

      const updated = new Date(c.time);
      document.getElementById('wxUpdated').textContent =
        `Updated ${updated.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

      // Forecast cards (first 5 days)
      const f = document.getElementById('forecast');
      f.innerHTML = "";
      const times = data.daily.time;
      const tmax = data.daily.temperature_2m_max;
      const tmin = data.daily.temperature_2m_min;
      const pSum = data.daily.precipitation_sum;
      const wCode = data.daily.weather_code;

      for(let i=0; i<Math.min(5, times.length); i++){
        const div = document.createElement("div");
        div.className = "fday";
        div.innerHTML = `
          <div class="d">${dayLabel(times[i])}</div>
          <div class="t">${Math.round(tmax[i])}° / ${Math.round(tmin[i])}°</div>
          <div class="s">${weatherCodeToText(wCode[i])}</div>
          <div class="s">Precip: ${(pSum[i] ?? 0).toFixed(1)} mm</div>
        `;
        f.appendChild(div);
      }
    }

    /***********************
     * NEWS (RSS -> HTML)
     ***********************/
    function setNewsStatus(kind){
      const el = document.getElementById("newsStatus");
      el.classList.remove("ok","warn","bad");
      if(kind === "ok"){ el.textContent = "Live"; el.classList.add("ok"); }
      else if(kind === "warn"){ el.textContent = "Partial"; el.classList.add("warn"); }
      else if(kind === "bad"){ el.textContent = "Unavailable"; el.classList.add("bad"); }
      else { el.textContent = "Fetching…"; }
    }

    function fmtTime(d){
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    }

    function stripHtml(s){
      return (s ?? "").replace(/<[^>]*>/g, "").trim();
    }

    async function fetchRssItems(rssUrl, maxItems=8){
      const res = await fetch(CORS_RAW(rssUrl), { cache:"no-store" });
      if(!res.ok) throw new Error("RSS fetch failed");
      const text = await res.text();

      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "text/xml");

      // Support RSS <item> and Atom <entry>
      const items = Array.from(xml.querySelectorAll("item")).slice(0, maxItems);
      if(items.length){
        return items.map(item => ({
          title: stripHtml(item.querySelector("title")?.textContent),
          link: item.querySelector("link")?.textContent?.trim() || item.querySelector("link")?.getAttribute("href") || "",
          pubDate: item.querySelector("pubDate")?.textContent?.trim() || ""
        }));
      }

      const entries = Array.from(xml.querySelectorAll("entry")).slice(0, maxItems);
      return entries.map(e => ({
        title: stripHtml(e.querySelector("title")?.textContent),
        link: e.querySelector("link")?.getAttribute("href") || "",
        pubDate: e.querySelector("updated")?.textContent?.trim() || e.querySelector("published")?.textContent?.trim() || ""
      }));
    }

    function renderNews(listElId, items){
      const ul = document.getElementById(listElId);
      ul.innerHTML = "";
      items.forEach(it => {
        const li = document.createElement("li");
        li.className = "newsitem";

        let when = "";
        if(it.pubDate){
          const d = new Date(it.pubDate);
          if(!isNaN(d.getTime())) when = d.toLocaleDateString([], {month:"short", day:"numeric"}) + " " + fmtTime(d);
        }

        li.innerHTML = `
          <a href="${it.link}" target="_blank" rel="noreferrer">${it.title || "Untitled"}</a>
          <div class="newsmeta">
            <span>${when || "—"}</span>
            <span class="dot"></span>
            <span>${new URL(it.link || "https://example.com").hostname.replace("www.","")}</span>
          </div>
        `;
        ul.appendChild(li);
      });

      if(!items.length){
        ul.innerHTML = `<li class="newsitem"><div class="muted">No headlines loaded.</div></li>`;
      }
    }

    async function loadNews(){
      setNewsStatus();
      let okCount = 0;

      const [local, world] = await Promise.allSettled([
        fetchRssItems(LOCAL_RSS, 8),
        fetchRssItems(WORLD_RSS, 8)
      ]);

      if(local.status === "fulfilled"){ renderNews("newsLocal", local.value); okCount++; }
      else { renderNews("newsLocal", []); }

      if(world.status === "fulfilled"){ renderNews("newsWorld", world.value); okCount++; }
      else { renderNews("newsWorld", []); }

      if(okCount === 2) setNewsStatus("ok");
      else if(okCount === 1) setNewsStatus("warn");
      else setNewsStatus("bad");

      document.getElementById("newsUpdated").textContent = `Updated ${fmtTime(new Date())}`;
    }

    /***********************
     * TRADINGVIEW TICKER
     ***********************/
    function addTradingViewTicker(){
      const container = document.getElementById("tv-ticker");
      container.innerHTML = ""; // reset

      const script = document.createElement("script");
      script.src = "https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js";
      script.async = true;
      script.innerHTML = JSON.stringify({
        symbols: TRADINGVIEW_SYMBOLS,
        showSymbolLogo: true,
        isTransparent: false,
        displayMode: "regular",
        locale: "en",
        colorTheme: "light"
      });

      container.appendChild(script);
    }

    /***********************
     * BOOTSTRAP
     ***********************/
    (async function init(){
      addTradingViewTicker();

      // Initial load
      try { await loadWeather(); } catch(e){
        document.getElementById('wxText').textContent = "Weather unavailable (network blocked?)";
        document.getElementById('wxUpdated').textContent = "Update failed";
      }

      try { await loadNews(); } catch(e){
        setNewsStatus("bad");
      }

      // Refresh intervals
      setInterval(() => loadWeather().catch(()=>{}), 5 * 60 * 1000); // every 5 min
      setInterval(() => loadNews().catch(()=>{}), 10 * 60 * 1000);  // every 10 min
    })();
  </script>
</body>
</html>
