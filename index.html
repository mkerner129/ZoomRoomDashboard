<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News Board (World • Local • Markets • Weather)</title>
  <style>
    :root{
      --bg1:#061a3a; --bg2:#0a2a5f; --bg3:#081833;
      --text:#eaf2ff; --muted:#b9d1ff; --border: rgba(255,255,255,.14);
      --shadow: 0 18px 44px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
      --radius: 26px; --gap: 16px; --tickerH: 56px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(54,194,255,.28), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(124,77,255,.22), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(255,176,32,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 50%, var(--bg3));
      overflow:hidden;
    }
    .sheen{
      position:absolute; inset:-60% -60%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.08) 45%, transparent 55%);
      transform: rotate(8deg);
      animation: sweep 14s linear infinite;
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.55;
    }
    @keyframes sweep{
      0%{transform: translateX(-22%) rotate(8deg)}
      100%{transform: translateX(22%) rotate(8deg)}
    }

    header{
      position:relative; z-index:2;
      padding:18px 22px 10px;
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;
    }
    .title{
      font-weight:1000; letter-spacing:-.6px; font-size:30px; line-height:1;
      text-transform:uppercase; text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .subline{
      margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:var(--muted); text-transform:uppercase; letter-spacing:.6px; font-weight:850; font-size:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border:1px solid var(--border);
      border-radius:999px; background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      font-size:12px; color:var(--muted); font-weight:850;
      letter-spacing:.4px; text-transform:uppercase; white-space:nowrap;
    }
    .clock{
      text-align:right; font-variant-numeric: tabular-nums;
      font-weight:1000; letter-spacing:-.2px; font-size:24px; text-transform:uppercase;
    }
    .clock small{
      display:block; margin-top:6px; color:var(--muted);
      font-size:12px; font-weight:850; letter-spacing:.7px;
    }

    main{
      position:relative; z-index:2;
      padding:0 22px 16px;
      height: calc(100% - 86px - var(--tickerH));
      display:grid; grid-template-columns: 1.35fr .95fr;
      gap: var(--gap); min-height:0;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      min-height:0;
    }
    .card-inner{ padding:16px; min-height:0; }

    .left{ display:grid; grid-template-rows: 1fr 1fr; gap: var(--gap); height:100%; min-height:0; }
    .right{ display:grid; grid-template-rows: 1fr auto; gap: var(--gap); height:100%; min-height:0; }

    .cardHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .cardHead h2{ margin:0; font-size:14px; font-weight:1000; letter-spacing:.8px; text-transform:uppercase; color:#fff; }

    .panel{
      border-radius:22px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:0;
      height: calc(100% - 40px);
    }

    .list{
      list-style:none; margin:0; padding:0;
      display:flex; flex-direction:column; gap:10px;
      overflow:auto; min-height:0;
    }
    .item{
      border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding:10px 10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .item .t{
      font-weight:1000; font-size:13px; letter-spacing:.2px; color:#fff; line-height:1.25;
      overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      text-transform:none;
    }
    .item .m{
      margin-top:6px; display:flex; justify-content:space-between; gap:10px;
      color:var(--muted); font-size:11px; font-weight:900; letter-spacing:.4px; text-transform:uppercase;
    }
    .item a{ color:inherit; text-decoration:none; }
    .empty{
      margin-top:10px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      padding:10px 12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.5px;
      text-transform:uppercase;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }

    .bottom{
      display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap);
      height: 260px; min-height:260px;
    }
    .miniCard .card-inner{ height:100%; display:flex; flex-direction:column; gap:12px; }
    .marketGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; flex:1 1 auto; }
    .quote{
      border-radius:18px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      padding:10px 12px; box-shadow: 0 10px 18px rgba(0,0,0,.22);
      display:flex; flex-direction:column; gap:6px;
    }
    .qSym{
      color:var(--muted); font-size:11px; font-weight:1000;
      letter-spacing:.7px; text-transform:uppercase;
      display:flex; justify-content:space-between; gap:10px;
    }
    .qVal{
      display:flex; justify-content:space-between; align-items:baseline; gap:10px;
      font-variant-numeric: tabular-nums;
    }
    .qPrice{ font-weight:1000; font-size:20px; letter-spacing:-.2px; color:#fff; }
    .qChg{
      font-weight:1000; font-size:13px; letter-spacing:.4px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      text-transform:uppercase; white-space:nowrap;
    }
    .up{ color:#b8ffdb; }
    .dn{ color:#ffb8c3; }
    .flat{ color:var(--muted); }

    .wxHero{
      border-radius:22px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      padding:12px;
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:center;
      flex:1 1 auto;
    }
    .wxTemp{ font-weight:1000; font-size:52px; letter-spacing:-1px; line-height:1; }
    .wxDesc{ margin-top:10px; font-weight:1000; letter-spacing:.6px; text-transform:uppercase; color:#fff; font-size:13px; }
    .wxMeta{ display:flex; flex-direction:column; gap:8px; color:var(--muted); font-weight:900; letter-spacing:.4px; text-transform:uppercase; font-size:12px; }
    .wxRow b{ color:#fff; font-variant-numeric: tabular-nums; }

    .ticker{
      position:absolute; left:0; right:0; bottom:0;
      height: var(--tickerH);
      z-index:3;
      border-top:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.28));
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .tickerTrack{
      height:100%;
      display:flex; align-items:center; gap:48px;
      padding-left:100%;
      animation: scroll 44s linear infinite;
      white-space:nowrap;
      font-weight:1000; letter-spacing:.7px; text-transform:uppercase;
      font-size:14px; color:#fff;
    }
    @keyframes scroll{ 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }
    .tickSep{ opacity:.35; }
    .tickMuted{ color:var(--muted); font-weight:900; }

    @media (max-width: 1200px){
      body{overflow:auto}
      main{ grid-template-columns:1fr; height:auto; }
      .bottom{ grid-template-columns:1fr; height:auto; min-height:0; }
      .ticker{ position:sticky; }
    }
  </style>
</head>

<body>
  <div class="sheen"></div>

  <header>
    <div>
      <div class="title">News Board</div>
      <div class="subline">
        <span class="pill" id="place">Bedford, Nova Scotia</span>
        <span class="pill" id="updated">Updating…</span>
        <span class="pill">Next refresh in <span id="refreshIn">--:--</span></span>
      </div>
    </div>
    <div class="clock" id="clock">
      --:--
      <small id="clockDate">—</small>
    </div>
  </header>

  <main>
    <section class="left">
      <div class="card">
        <div class="card-inner">
          <div class="cardHead">
            <h2>World</h2>
            <span class="pill" id="worldMeta">—</span>
          </div>
          <div class="panel">
            <ul class="list" id="worldList"></ul>
            <div class="empty" id="worldEmpty" style="display:none;"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-inner">
          <div class="cardHead">
            <h2>Local</h2>
            <span class="pill" id="localMeta">—</span>
          </div>
          <div class="panel">
            <ul class="list" id="localList"></ul>
            <div class="empty" id="localEmpty" style="display:none;"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="right">
      <div class="card">
        <div class="card-inner">
          <div class="cardHead">
            <h2>More Local</h2>
            <span class="pill" id="mixMeta">—</span>
          </div>
          <div class="panel" style="height: calc(100% - 40px);">
            <ul class="list" id="mixList"></ul>
            <div class="empty" id="mixEmpty" style="display:none;"></div>
          </div>
        </div>
      </div>

      <div class="bottom">
        <div class="card miniCard">
          <div class="card-inner">
            <div class="cardHead">
              <h2>Markets</h2>
              <span class="pill" id="mktMeta">—</span>
            </div>
            <div class="marketGrid" id="marketGrid"></div>
          </div>
        </div>

        <div class="card miniCard">
          <div class="card-inner">
            <div class="cardHead">
              <h2>Weather</h2>
              <span class="pill" id="wxMeta">—</span>
            </div>
            <div class="wxHero">
              <div>
                <div class="wxTemp"><span id="wxTemp">--</span>°</div>
                <div class="wxDesc" id="wxDesc">Loading…</div>
              </div>
              <div class="wxMeta">
                <div class="wxRow">Feels <b id="wxFeels">--</b>°</div>
                <div class="wxRow">Wind <b id="wxWind">--</b> km/h <b id="wxDir">--</b></div>
                <div class="wxRow">Precip <b id="wxP">--</b> mm</div>
                <div class="wxRow">Hum <b id="wxH">--</b>% • Cloud <b id="wxC">--</b>%</div>
              </div>
            </div>
            <div class="empty" id="wxEmpty" style="display:none;"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="ticker" aria-label="Ticker">
    <div class="tickerTrack" id="tickerTrack">
      <span class="tickMuted">Loading…</span>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const LOCATION = { lat: 44.7326, lon: -63.6533, label: "Bedford, Nova Scotia" };
    const REFRESH_MS = 4 * 60 * 1000;
    let nextRefreshAt = Date.now() + REFRESH_MS;

    // RSS proxy (no-key). Sometimes blocked; we show a clear message if so.
    const RSS_PROXY = (url) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);

    // Feeds (safe defaults; tweak anytime)
    const FEEDS = {
      world: [
        { name:"BBC World", url:"https://feeds.bbci.co.uk/news/world/rss.xml" },
        { name:"Reuters Top", url:"https://feeds.reuters.com/reuters/topNews" }
      ],
      local: [
        { name:"CBC Nova Scotia", url:"https://rss.cbc.ca/lineup/canada-novascotia.xml" },
        { name:"Global Halifax",  url:"https://globalnews.ca/halifax/feed/" }
      ]
    };

    // Markets from Yahoo quote API (often less CORS pain than CSV sites).
    // If blocked, we show "Unavailable" but the rest works.
    const YAHOO = {
      base: "https://query1.finance.yahoo.com/v7/finance/quote?symbols=",
      symbols: [
        { label:"S&P 500", sym:"^GSPC" },
        { label:"Dow",     sym:"^DJI" },
        { label:"Nasdaq",  sym:"^IXIC" },
        { label:"TSX",     sym:"^GSPTSE" }
      ]
    };

    // ==========================
    // HELPERS
    // ==========================
    const $ = (id) => document.getElementById(id);

    function fmtTime12(d){
      let h = d.getHours();
      const m = String(d.getMinutes()).padStart(2,"0");
      const ap = h >= 12 ? "PM" : "AM";
      h = h % 12; if(h === 0) h = 12;
      return h + ":" + m + ap;
    }
    function fmtDateLine(d){
      return d.toLocaleDateString([], { weekday:"long", month:"short", day:"numeric" }).toUpperCase();
    }
    function tickClock(){
      const d = new Date();
      $("clock").childNodes[0].textContent = String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0") + "\n      ";
      $("clockDate").textContent = fmtDateLine(d);
    }
    function tickCountdown(){
      const left = Math.max(0, nextRefreshAt - Date.now());
      const s = Math.floor(left/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      $("refreshIn").textContent = String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    function timeAgo(iso){
      const t = Date.parse(iso || "");
      if(!isFinite(t)) return "";
      const s = Math.max(0, Math.floor((Date.now() - t)/1000));
      if(s < 60) return s + "s ago";
      const m = Math.floor(s/60);
      if(m < 60) return m + "m ago";
      const h = Math.floor(m/60);
      if(h < 24) return h + "h ago";
      const d = Math.floor(h/24);
      return d + "d ago";
    }
    async function fetchText(url){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }
    async function fetchJson(url){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    function setEmpty(which, msg){
      const empty = $(which + "Empty");
      const list = $(which + "List");
      if(msg){
        empty.style.display = "";
        empty.textContent = msg;
        if(list) list.innerHTML = "";
      } else {
        empty.style.display = "none";
      }
    }

    function renderList(listId, items, max){
      const ul = $(listId);
      ul.innerHTML = "";
      items.slice(0, max).forEach(x => {
        const li = document.createElement("li");
        li.className = "item";
        const when = x.pubDate ? timeAgo(x.pubDate) : "";
        li.innerHTML = `
          <a href="${x.link || "#"}" target="_blank" rel="noopener">
            <div class="t">${escapeHtml(x.title || "—")}</div>
            <div class="m">
              <span>${escapeHtml(when || "")}</span>
              <span>${escapeHtml((x.source || "").toUpperCase())}</span>
            </div>
          </a>`;
        ul.appendChild(li);
      });
    }

    function parseRSS(xmlText){
      const doc = new DOMParser().parseFromString(xmlText, "text/xml");
      const items = Array.from(doc.querySelectorAll("item")).slice(0, 30).map(it => {
        const title = (it.querySelector("title")?.textContent || "").trim();
        const link  = (it.querySelector("link")?.textContent || "").trim();
        const pub   = (it.querySelector("pubDate")?.textContent || it.querySelector("dc\\:date")?.textContent || "").trim();
        return { title, link, pubDate: pub };
      }).filter(x => x.title);
      return items;
    }

    function mergeAndSort(groups){
      const all = [];
      groups.forEach(g => g.items.forEach(x => all.push({ ...x, source: g.name })));
      all.sort((a,b) => (Date.parse(b.pubDate||"")||0) - (Date.parse(a.pubDate||"")||0));
      const seen = new Set();
      const out = [];
      for(const x of all){
        const key = x.title.toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);
        out.push(x);
      }
      return out;
    }

    function setTicker(parts){
      const track = $("tickerTrack");
      const safe = parts.filter(Boolean);
      const html = safe.map(p => `<span>${escapeHtml(p)}</span>`).join(`<span class="tickSep"> • </span>`);
      track.innerHTML = (html || `<span class="tickMuted">No ticker data available</span>`) +
                        `<span class="tickSep"> • </span>` +
                        (html || `<span class="tickMuted">No ticker data available</span>`);
    }

    // ==========================
    // WEATHER (Open-Meteo)
    // ==========================
    function wxText(code){
      const wc = Number(code);
      const map = {
        0:"CLEAR",1:"MOSTLY CLEAR",2:"PARTLY CLOUDY",3:"OVERCAST",45:"FOG",48:"RIME FOG",
        51:"LIGHT DRIZZLE",53:"DRIZZLE",55:"HEAVY DRIZZLE",56:"FREEZING DRIZZLE",57:"HEAVY FREEZING DRIZZLE",
        61:"LIGHT RAIN",63:"RAIN",65:"HEAVY RAIN",66:"FREEZING RAIN",67:"HEAVY FREEZING RAIN",
        71:"LIGHT SNOW",73:"SNOW",75:"HEAVY SNOW",77:"SNOW GRAINS",
        80:"RAIN SHOWERS",81:"SHOWERS",82:"STRONG SHOWERS",
        85:"SNOW SHOWERS",86:"HEAVY SNOW SHOWERS",95:"THUNDERSTORM",96:"T-STORM WITH HAIL",99:"SEVERE T-STORM"
      };
      return map[wc] || ("WEATHER (" + wc + ")");
    }
    function windDirText(deg){
      if(deg==null || isNaN(deg)) return "—";
      const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      return dirs[Math.round(deg/22.5)%16];
    }

    async function loadWeather(){
      const url =
        "https://api.open-meteo.com/v1/forecast?latitude=" + LOCATION.lat + "&longitude=" + LOCATION.lon +
        "&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,wind_speed_10m,wind_direction_10m,weather_code,cloud_cover" +
        "&timezone=auto";

      const data = await fetchJson(url);
      const c = data.current;

      $("wxTemp").textContent  = Math.round(Number(c.temperature_2m || 0));
      $("wxFeels").textContent = Math.round(Number(c.apparent_temperature || 0));
      $("wxH").textContent     = Math.round(Number(c.relative_humidity_2m || 0));
      $("wxC").textContent     = Math.round(Number(c.cloud_cover || 0));
      $("wxP").textContent     = (Number(c.precipitation || 0)).toFixed(1);
      $("wxWind").textContent  = Math.round(Number(c.wind_speed_10m || 0));
      $("wxDir").textContent   = windDirText(c.wind_direction_10m);
      $("wxDesc").textContent  = wxText(c.weather_code);
      $("wxMeta").textContent  = "UPDATED " + fmtTime12(new Date(c.time));
      setEmpty("wx", "");
    }

    // ==========================
    // NEWS (RSS via AllOrigins)
    // ==========================
    async function loadFeedGroup(feedList){
      const out = [];
      for(const f of feedList){
        try{
          const xml = await fetchText(RSS_PROXY(f.url));
          const items = parseRSS(xml);
          out.push({ name: f.name, items });
        }catch(e){
          out.push({ name: f.name, items: [] });
        }
      }
      return out;
    }

    // ==========================
    // MARKETS (Yahoo quote endpoint)
    // ==========================
    async function loadMarkets(){
      const grid = $("marketGrid");
      grid.innerHTML = "";
      $("mktMeta").textContent = "UPDATING…";

      const symbols = YAHOO.symbols.map(x => x.sym).join(",");
      try{
        const data = await fetchJson(YAHOO.base + encodeURIComponent(symbols));
        const quotes = (data && data.quoteResponse && data.quoteResponse.result) ? data.quoteResponse.result : [];

        const tickerParts = [];
        for(const m of YAHOO.symbols){
          const q = quotes.find(z => z.symbol === m.sym);
          const price = q && isFinite(q.regularMarketPrice) ? Number(q.regularMarketPrice) : NaN;
          const chg = q && isFinite(q.regularMarketChange) ? Number(q.regularMarketChange) : NaN;
          const pct = q && isFinite(q.regularMarketChangePercent) ? Number(q.regularMarketChangePercent) : NaN;

          const cls = !isFinite(chg) ? "flat" : (chg > 0 ? "up" : (chg < 0 ? "dn" : "flat"));
          const chgText = !isFinite(chg) ? "—" : ((chg > 0 ? "+" : "") + chg.toFixed(2) + " (" + (pct>0?"+":"") + pct.toFixed(2) + "%)");

          const box = document.createElement("div");
          box.className = "quote";
          box.innerHTML = `
            <div class="qSym"><span>${escapeHtml(m.label)}</span><span class="tickMuted">${escapeHtml(m.sym)}</span></div>
            <div class="qVal">
              <div class="qPrice">${isFinite(price) ? price.toFixed(2) : "—"}</div>
              <div class="qChg ${cls}">${escapeHtml(chgText)}</div>
            </div>
          `;
          grid.appendChild(box);

          tickerParts.push(m.label + " " + (isFinite(price)?price.toFixed(2):"—") + " " + (isFinite(pct)?((pct>0?"+":"")+pct.toFixed(2)+"%"):""));
        }

        $("mktMeta").textContent = "UPDATED";
        return tickerParts;
      }catch(e){
        // render placeholders
        for(const m of YAHOO.symbols){
          const box = document.createElement("div");
          box.className = "quote";
          box.innerHTML = `
            <div class="qSym"><span>${escapeHtml(m.label)}</span><span class="tickMuted">${escapeHtml(m.sym)}</span></div>
            <div class="qVal">
              <div class="qPrice">—</div>
              <div class="qChg flat">UNAVAILABLE</div>
            </div>
          `;
          grid.appendChild(box);
        }
        $("mktMeta").textContent = "NO DATA";
        return [];
      }
    }

    // ==========================
    // REFRESH LOOP
    // ==========================
    async function refreshAll(){
      const started = Date.now();
      $("updated").textContent = "UPDATING…";

      // Weather first (known-good)
      await loadWeather().catch(() => {
        $("wxMeta").textContent = "NO DATA";
        $("wxDesc").textContent = "UNAVAILABLE";
        setEmpty("wx", "Weather failed to load.");
      });

      // News
      const [worldSrc, localSrc] = await Promise.all([
        loadFeedGroup(FEEDS.world),
        loadFeedGroup(FEEDS.local)
      ]);

      const world = mergeAndSort(worldSrc);
      const local = mergeAndSort(localSrc);

      if(world.length){
        $("worldMeta").textContent = world.length + " ITEMS";
        setEmpty("world", "");
        renderList("worldList", world, 10);
      } else {
        $("worldMeta").textContent = "NO DATA";
        setEmpty("world", "World news blocked.\nLikely: AllOrigins or RSS fetch blocked by your network.\nIf you want 'always works', we should use RSS2JSON with a key or host a tiny proxy.");
      }

      if(local.length){
        $("localMeta").textContent = local.length + " ITEMS";
        setEmpty("local", "");
        renderList("localList", local, 10);

        $("mixMeta").textContent = Math.min(18, local.length) + " ITEMS";
        setEmpty("mix", "");
        renderList("mixList", local, 18);
      } else {
        $("localMeta").textContent = "NO DATA";
        $("mixMeta").textContent = "NO DATA";
        setEmpty("local", "Local news blocked.\nWe can swap feeds or use RSS2JSON/proxy.");
        setEmpty("mix", "Local news blocked.\nWe can swap feeds or use RSS2JSON/proxy.");
      }

      // Markets
      const mktParts = await loadMarkets();

      // Ticker (never empty)
      const tickerParts = [];
      tickerParts.push("WORLD: " + (world[0]?.title || "—"));
      tickerParts.push("LOCAL: " + (local[0]?.title || "—"));
      if(mktParts.length) mktParts.forEach(p => tickerParts.push("MKT: " + p));
      else tickerParts.push("MKT: UNAVAILABLE");
      tickerParts.push("WEATHER: " + ($("wxDesc").textContent || "—") + " " + ($("wxTemp").textContent || "--") + "°");
      setTicker(tickerParts);

      const took = Math.max(1, Math.round((Date.now() - started)/1000));
      $("updated").textContent = "UPDATED " + fmtTime12(new Date()) + " • " + took + "s";

      nextRefreshAt = Date.now() + REFRESH_MS;
      tickCountdown();
    }

    function start(){
      $("place").textContent = LOCATION.label;

      tickClock(); setInterval(tickClock, 1000);
      tickCountdown(); setInterval(tickCountdown, 1000);

      refreshAll().catch(()=>{ $("updated").textContent = "UPDATE FAILED"; });
      setInterval(()=>{ refreshAll().catch(()=>{}); }, REFRESH_MS);
    }

    document.addEventListener("DOMContentLoaded", start);
  </script>
</body>
</html>
