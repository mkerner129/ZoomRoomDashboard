<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Room Dashboard — Halifax</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#e2e8f0;
      --shadow:0 6px 18px rgba(2,6,23,.08);
      --accent:#2563eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.70);
      backdrop-filter: blur(6px);
      position:sticky; top:0; z-index:10;
    }
    .title{font-size:22px;font-weight:800}
    .subtitle{color:var(--muted);font-size:14px;margin-top:4px}
    .clock{font-variant-numeric: tabular-nums;font-size:18px;font-weight:700}
    main{
      padding:18px 22px 26px;
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      grid-template-rows: auto auto auto;
      gap:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .card h2{margin:0 0 10px;font-size:16px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff}
    .muted{color:var(--muted)}
    .span-2{grid-column:1 / -1}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

    /* Weather */
    .weather-grid{display:grid;grid-template-columns: 1fr 1fr;gap:12px;align-items:start}
    .temp-row{display:flex;align-items:center;gap:12px}
    .temp{font-size:54px;font-weight:900;letter-spacing:-1px;line-height:1;margin-top:2px}
    #wxIcon{width:84px;height:84px;display:flex;align-items:center;justify-content:center}
    .wxline{font-size:14px;color:var(--muted)}
    .kv{display:grid;grid-template-columns: 1fr auto;gap:8px;font-size:14px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:#fff;margin-bottom:8px}
    .kv b{font-variant-numeric: tabular-nums;}
    .forecast{display:grid;grid-template-columns: repeat(5, 1fr);gap:10px;margin-top:10px}
    .fday{border:1px solid var(--border);border-radius:14px;padding:10px;background:#fff;min-height:90px;display:flex;flex-direction:column;gap:6px;align-items:center}
    .fday .d{font-weight:800;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
    .fday .t{font-weight:900;font-size:16px}
    .fday .s{font-size:12px;color:var(--muted);text-align:center}

    /* News */
    .news-cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .newslist{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
    .newsitem{padding:10px;border:1px solid var(--border);border-radius:14px;background:#fff;display:flex;flex-direction:column;gap:6px;min-height:58px}
    .newsitem a{color:var(--text);text-decoration:none;font-weight:800;font-size:14px}
    .newsmeta{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}

    /* Markets chart */
    .markets-chart{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      height:240px;
    }
    .mk-error{
      margin-top:8px;
      padding:8px 10px;
      border:1px dashed var(--border);
      border-radius:12px;
      font-size:12px;
      color:var(--muted);
      background:#fff;
      white-space:pre-wrap;
      word-break:break-word;
      display:block;
      min-height: 0;
    }

    .foot{margin-top:10px;font-size:12px;color:var(--muted)}
    @media (max-width:1100px){main{grid-template-columns:1fr}.forecast{grid-template-columns:repeat(3,1fr)}}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Room Dashboard</div>
      <div class="subtitle">Halifax, Nova Scotia • Weather • News • Markets</div>
    </div>
    <div class="clock" id="clock">--:--</div>
  </header>

  <main>
    <!-- WEATHER -->
    <section class="card">
      <h2>
        <span>Live Weather — Halifax</span>
        <span class="badge" id="wxUpdated">Updating…</span>
      </h2>

      <div class="weather-grid">
        <div>
          <div class="temp-row">
            <div id="wxIcon" aria-hidden="true"></div>
            <div>
              <div class="temp"><span id="temp">--</span>°C</div>
              <div class="wxline" id="wxText">Loading…</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="forecast" id="forecast"></div>

          <div class="foot">Weather data: Open-Meteo (no API key).</div>
        </div>

        <div>
          <div class="kv"><span>Feels like</span><b><span id="apparent">--</span>°C</b></div>
          <div class="kv"><span>Wind</span><b><span id="wind">--</span> km/h</b></div>
          <div class="kv"><span>Precip (now)</span><b><span id="precip">--</span> mm</b></div>
          <div class="kv"><span>Humidity</span><b><span id="humidity">--</span>%</b></div>
          <div class="kv"><span>Cloud cover</span><b><span id="cloud">--</span>%</b></div>
          <div class="kv"><span>UV index</span><b><span id="uv">--</span></b></div>
        </div>
      </div>
    </section>

    <!-- MARKETS -->
    <section class="card">
      <h2>
        <span>Markets</span>
        <span class="badge" id="mkUpdated">Updating…</span>
      </h2>

      <div class="markets-chart">
        <div class="row" style="justify-content:space-between;margin-bottom:8px;align-items:center">
          <div style="font-weight:900">S&P 500 vs Dow (1Y, normalized)</div>
          <div class="badge">Line</div>
        </div>
        <canvas id="mkChart"></canvas>
        <div class="mk-error" id="mkError"></div>
      </div>

      <div class="foot">
        Markets data: Yahoo Finance chart endpoint (no API key). If it fails, the error shows above.
      </div>
    </section>

    <!-- NEWS -->
    <section class="card span-2">
      <h2 style="display:flex;justify-content:space-between;align-items:center">
        <span>Top News</span>
        <span class="muted" id="newsUpdated">—</span>
      </h2>

      <div class="news-cols">
        <div>
          <div style="font-weight:900;margin-bottom:10px">Local (Nova Scotia)</div>
          <ul class="newslist" id="newsLocal"></ul>
        </div>

        <div>
          <div style="font-weight:900;margin-bottom:10px">World (BBC)</div>
          <ul class="newslist" id="newsWorld"></ul>
        </div>
      </div>

      <div class="foot">If headlines don't load, your network may block cross-origin requests — see IT.</div>
    </section>
  </main>

  <!-- Chart.js + time adapter (Option A: date-fns BEFORE adapter) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <script>
    // -------------------------
    // Configuration
    // -------------------------
    const HALIFAX = { lat: 44.6488, lon: -63.5752, tz: "America/Halifax" };
    const LOCAL_RSS = "https://novascotia.ca/news/rss/";
    const WORLD_RSS = "https://feeds.bbci.co.uk/news/rss.xml?edition=int";
    const CORS_RAW = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

    // Clock
    function tickClock(){
      const d=new Date();
      const hh=String(d.getHours()).padStart(2,'0');
      const mm=String(d.getMinutes()).padStart(2,'0');
      document.getElementById('clock').textContent = `${hh}:${mm}`;
    }
    tickClock(); setInterval(tickClock, 1000);

    // Inline SVG icons generator (simple, lightweight)
    function svgFor(code, size=84){
      const cloudy = [2,3];
      const fog = [45,48];
      const drizzle = [51,53,55,56,57];
      const rain = [61,63,65,66,67,80,81,82];
      const snow = [71,73,75,77,85,86];
      const thunder = [95,96,99];

      let kind = "clear";
      if (fog.includes(code)) kind="fog";
      else if (drizzle.includes(code)) kind="drizzle";
      else if (rain.includes(code)) kind="rain";
      else if (snow.includes(code)) kind="snow";
      else if (thunder.includes(code)) kind="thunder";
      else if (cloudy.includes(code)) kind="partly";
      else if (code===1) kind="partly";
      else if (code===0) kind="clear";

      if(kind==="clear"){
        return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#FFDD57"/><stop offset="1" stop-color="#FFB020"/></linearGradient></defs>
          <circle cx="32" cy="32" r="14" fill="url(#g1)"/>
        </svg>`;
      }
      if(kind==="partly"){
        return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs><linearGradient id="s1" x1="0" x2="1"><stop offset="0" stop-color="#FFDD57"/><stop offset="1" stop-color="#FFB020"/></linearGradient></defs>
          <circle cx="22" cy="22" r="10" fill="url(#s1)"/>
          <g transform="translate(6,24)" fill="#E6EEF8">
            <ellipse cx="22" cy="16" rx="18" ry="10"/>
            <ellipse cx="10" cy="18" rx="12" ry="7"/>
          </g>
        </svg>`;
      }
      if(kind==="fog"){
        return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <rect width="64" height="64" rx="10" fill="#E6EEF8"/>
          <g fill="#B0BEC5">
            <rect x="8" y="22" width="48" height="4" rx="2"/>
            <rect x="6" y="30" width="52" height="4" rx="2"/>
            <rect x="10" y="38" width="44" height="4" rx="2"/>
          </g>
        </svg>`;
      }
      if(kind==="drizzle"){
        return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <g>
            <ellipse cx="34" cy="24" rx="18" ry="10" fill="#E6EEF8"/>
            <g fill="#6B7280"><rect x="26" y="36" width="4" height="10" rx="2"/><rect x="34" y="36" width="4" height="10" rx="2"/><rect x="42" y="36" width="4" height="10" rx="2"/></g>
          </g>
        </svg>`;
      }
      if(kind==="rain"){
        return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <g><ellipse cx="34" cy="20" rx="18" ry="10" fill="#E6EEF8"/></g>
          <g fill="#2563EB"><path d="M26 36c0 4-4 6-4 10 0 2 4 4 4 4s4-2 4-4c0-4-4-6-4-10z"/><path d="M36 36c0 4-4 6-4 10 0 2 4 4 4 4s4-2 4-4c0-4-4-6-4-10z"/><path d="M46 36c0 4-4 6-4 10 0 2 4 4 4 4s4-2 4-4c0-4-4-6-4-10z"/></g>
        </svg>`;
      }
      if(kind==="snow"){
        return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <ellipse cx="34" cy="22" rx="18" ry="10" fill="#E6EEF8"/>
          <g fill="#6B7280" transform="translate(14,28)"><circle cx="8" cy="12" r="2"/><circle cx="20" cy="16" r="2"/><circle cx="34" cy="12" r="2"/></g>
        </svg>`;
      }
      if(kind==="thunder"){
        return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <ellipse cx="34" cy="22" rx="18" ry="10" fill="#E6EEF8"/>
          <polygon points="30,36 36,36 28,48 34,36 28,36" fill="#F59E0B"/>
        </svg>`;
      }
      return `<svg width="${size}" height="${size}" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="64" height="64" rx="10" fill="#E6EEF8"/></svg>`;
    }

    // Weather mapping & UI update (Open-Meteo)
    function weatherCodeToText(code){
      const map = {
        0:"Clear",
        1:"Mainly clear",
        2:"Partly cloudy",
        3:"Overcast",
        45:"Fog",
        48:"Depositing rime fog",
        51:"Light drizzle",
        53:"Moderate drizzle",
        55:"Dense drizzle",
        56:"Freezing drizzle",
        57:"Heavy freezing drizzle",
        61:"Slight rain",
        63:"Moderate rain",
        65:"Heavy rain",
        66:"Freezing rain",
        67:"Heavy freezing rain",
        71:"Slight snow",
        73:"Moderate snow",
        75:"Heavy snow",
        77:"Snow grains",
        80:"Rain showers",
        81:"Moderate showers",
        82:"Violent showers",
        85:"Snow showers",
        86:"Heavy snow showers",
        95:"Thunderstorm",
        96:"Thunderstorm with hail",
        99:"Thunderstorm with heavy hail"
      };
      return map[code] ?? `Weather (${code})`;
    }

    function dayLabel(isoDate){
      const d = new Date(isoDate + "T00:00:00");
      return d.toLocaleDateString([], { weekday: "short" });
    }

    async function loadWeather(){
      const {lat, lon, tz} = HALIFAX;
      const url =
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,wind_speed_10m,weather_code,cloud_cover,uv_index` +
        `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=${encodeURIComponent(tz)}`;

      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("Weather fetch failed");
      const data = await res.json();
      const c = data.current;

      document.getElementById('temp').textContent = Math.round(c.temperature_2m);
      document.getElementById('apparent').textContent = Math.round(c.apparent_temperature);
      document.getElementById('wind').textContent = Math.round(c.wind_speed_10m);
      document.getElementById('precip').textContent = (c.precipitation ?? 0).toFixed(1);
      document.getElementById('humidity').textContent = Math.round(c.relative_humidity_2m ?? 0);
      document.getElementById('cloud').textContent = Math.round(c.cloud_cover ?? 0);
      document.getElementById('uv').textContent = (c.uv_index ?? 0).toFixed(1);

      document.getElementById('wxText').textContent = weatherCodeToText(c.weather_code);
      document.getElementById('wxUpdated').textContent = `Updated ${new Date(c.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

      // icon
      document.getElementById('wxIcon').innerHTML = svgFor(c.weather_code, 84);

      // forecast
      const f = document.getElementById('forecast');
      f.innerHTML = "";
      const times = data.daily.time;
      const tmax = data.daily.temperature_2m_max;
      const tmin = data.daily.temperature_2m_min;
      const pSum = data.daily.precipitation_sum;
      const wCode = data.daily.weather_code;

      for(let i=0;i<Math.min(5,times.length);i++){
        const div = document.createElement('div');
        div.className = 'fday';
        div.innerHTML = `
          <div class="d">${dayLabel(times[i])}</div>
          <div style="height:6px"></div>
          <div class="t">${Math.round(tmax[i])}° / ${Math.round(tmin[i])}°</div>
          <div class="s">${weatherCodeToText(wCode[i])}</div>
          <div style="height:6px"></div>
          <div style="width:48px;height:48px">${svgFor(wCode[i],48)}</div>
          <div style="height:4px"></div>
          <div class="s">Precip: ${(pSum[i]??0).toFixed(1)} mm</div>
        `;
        f.appendChild(div);
      }
    }

    // -------------------------
    // News (RSS via allorigins)
    // -------------------------
    function stripHtml(s){ return (s ?? "").replace(/<[^>]*>/g,"").trim(); }
    function fmtTime(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }

    async function fetchRssItems(rssUrl, maxItems=6){
      const res = await fetch(CORS_RAW(rssUrl), {cache:"no-store"});
      if(!res.ok) throw new Error("RSS fetch failed");
      const text = await res.text();
      const xml = new DOMParser().parseFromString(text, "text/xml");
      const items = Array.from(xml.querySelectorAll("item")).slice(0,maxItems);
      if(items.length) return items.map(item=>({
        title: stripHtml(item.querySelector("title")?.textContent),
        link: item.querySelector("link")?.textContent?.trim() || "",
        pubDate: item.querySelector("pubDate")?.textContent?.trim() || ""
      }));
      const entries = Array.from(xml.querySelectorAll("entry")).slice(0,maxItems);
      return entries.map(e=>({
        title: stripHtml(e.querySelector("title")?.textContent),
        link: e.querySelector("link")?.getAttribute("href") || "",
        pubDate: e.querySelector("updated")?.textContent?.trim() || e.querySelector("published")?.textContent?.trim() || ""
      }));
    }

    function renderNews(listElId, items){
      const ul = document.getElementById(listElId); ul.innerHTML="";
      if(!items.length){ ul.innerHTML=`<li class="newsitem"><div class="muted">No headlines.</div></li>`; return; }
      items.forEach(it=>{
        const li=document.createElement('li'); li.className='newsitem';
        let when = ""; if(it.pubDate){ const d=new Date(it.pubDate); if(!isNaN(d)) when = d.toLocaleDateString([], {month:"short", day:"numeric"}) + " " + fmtTime(d); }
        li.innerHTML = `<a href="${it.link}" target="_blank" rel="noreferrer">${it.title || "Untitled"}</a>
          <div class="newsmeta"><span>${when || "—"}</span><span style="margin-left:8px;color:var(--muted)">${new URL(it.link||"https://example.com").hostname.replace("www.","")}</span></div>`;
        ul.appendChild(li);
      });
    }

    async function loadNews(){
      try{
        const [local, world] = await Promise.all([
          fetchRssItems(LOCAL_RSS,6).catch(()=>[]),
          fetchRssItems(WORLD_RSS,6).catch(()=>[])
        ]);
        renderNews("newsLocal", local);
        renderNews("newsWorld", world);
        document.getElementById('newsUpdated').textContent = `Updated ${fmtTime(new Date())}`;
      }catch(e){
        document.getElementById('newsUpdated').textContent = "News unavailable";
      }
    }

    // -------------------------
    // Markets (Yahoo Finance)
    // -------------------------
    let mkChart;

    function setMkError(msg){
      const el = document.getElementById("mkError");
      if (!el) return;
      el.textContent = msg || "";
    }

    async function fetchYahoo(symbol) {
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=1y&interval=1d`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Yahoo HTTP ${res.status}`);

      const json = await res.json();
      const result = json?.chart?.result?.[0];
      if (!result) throw new Error("Yahoo returned no result");

      const timestamps = result.timestamp || [];
      const closes = result?.indicators?.quote?.[0]?.close || [];
      const points = [];

      for (let i = 0; i < timestamps.length; i++) {
        const t = timestamps[i] * 1000;
        const c = closes[i];
        if (c != null && Number.isFinite(c)) points.push({ x: t, y: c });
      }
      points.sort((a,b)=>a.x-b.x);
      if (points.length < 30) throw new Error("Not enough points returned");
      return points;
    }

    function normalizeTo100(points) {
      if (!points.length) return points;
      const base = points[0].y;
      return points.map(p => ({ x: p.x, y: (p.y / base) * 100 }));
    }

    async function renderMarketsChart() {
      const badge = document.getElementById("mkUpdated");
      try {
        if (badge) badge.textContent = "Updating…";
        setMkError("Loading markets…");

        const [spxRaw, djiRaw] = await Promise.all([
          fetchYahoo("^GSPC"), // S&P 500
          fetchYahoo("^DJI")   // Dow Jones
        ]);

        const spx = normalizeTo100(spxRaw);
        const dji = normalizeTo100(djiRaw);

        const canvas = document.getElementById("mkChart");
        if (!canvas) throw new Error("Missing mkChart canvas");

        if (mkChart) mkChart.destroy();

        mkChart = new Chart(canvas, {
          type: "line",
          data: {
            datasets: [
              { label: "S&P 500 (norm.)", data: spx, parsing:false, pointRadius:0, borderWidth:2, tension:0.25 },
              { label: "Dow Jones (norm.)", data: dji, parsing:false, pointRadius:0, borderWidth:2, tension:0.25 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: { legend: { display: true } },
            scales: {
              x: { type: "time", time: { unit: "month" }, ticks: { maxTicksLimit: 6, maxRotation: 0, autoSkip: true } },
              y: { ticks: { display: false }, grid: { drawBorder: false } }
            }
          }
        });

        if (badge) badge.textContent = `Updated ${fmtTime(new Date())}`;
        setMkError("");
      } catch (e) {
        console.error("Markets error:", e);
        if (badge) badge.textContent = "Markets unavailable";
        setMkError(`Markets load failed.\n\nError: ${e?.message || e}`);
      }
    }

    // -------------------------
    // Boot
    // -------------------------
    (async function init(){
      try{ await loadWeather(); }catch(e){
        document.getElementById('wxText').textContent = "Weather unavailable";
      }
      try{ await loadNews(); }catch(e){}

      // Markets
      try{ await renderMarketsChart(); }catch(e){}

      setInterval(()=>loadWeather().catch(()=>{}), 5*60*1000);
      setInterval(()=>loadNews().catch(()=>{}), 10*60*1000);
      setInterval(()=>renderMarketsChart().catch(()=>{}), 60*60*1000);
    })();
  </script>
</body>
</html>
