<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News Board (World • Local • Markets • Weather)</title>
  <style>
    :root{
      --bg1:#061a3a; --bg2:#0a2a5f; --bg3:#081833;
      --text:#eaf2ff; --muted:#b9d1ff; --border: rgba(255,255,255,.14);
      --shadow: 0 18px 44px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
      --radius: 26px; --gap: 16px; --tickerH: 56px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(54,194,255,.28), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(124,77,255,.22), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(255,176,32,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 50%, var(--bg3));
      overflow:hidden;
    }
    .sheen{
      position:absolute; inset:-60% -60%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.08) 45%, transparent 55%);
      transform: rotate(8deg);
      animation: sweep 14s linear infinite;
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.55;
    }
    @keyframes sweep{
      0%{transform: translateX(-22%) rotate(8deg)}
      100%{transform: translateX(22%) rotate(8deg)}
    }

    header{
      position:relative; z-index:2;
      padding:18px 22px 10px;
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;
    }
    .title{
      font-weight:1000; letter-spacing:-.6px; font-size:30px; line-height:1;
      text-transform:uppercase; text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .subline{
      margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:var(--muted); text-transform:uppercase; letter-spacing:.6px; font-weight:850; font-size:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border:1px solid var(--border);
      border-radius:999px; background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      font-size:12px; color:var(--muted); font-weight:850;
      letter-spacing:.4px; text-transform:uppercase; white-space:nowrap;
    }
    .clock{
      text-align:right; font-variant-numeric: tabular-nums;
      font-weight:1000; letter-spacing:-.2px; font-size:24px; text-transform:uppercase;
    }
    .clock small{
      display:block; margin-top:6px; color:var(--muted);
      font-size:12px; font-weight:850; letter-spacing:.7px;
    }

    main{
      position:relative; z-index:2;
      padding:0 22px 16px;
      height: calc(100% - 86px - var(--tickerH));
      display:grid; grid-template-columns: 1.35fr .95fr;
      gap: var(--gap); min-height:0;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      min-height:0;
    }
    .card-inner{ padding:16px; min-height:0; }

    .left{ display:grid; grid-template-rows: 1fr 1fr; gap: var(--gap); height:100%; min-height:0; }
    .right{ display:grid; grid-template-rows: 1fr auto; gap: var(--gap); height:100%; min-height:0; }

    .cardHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .cardHead h2{ margin:0; font-size:14px; font-weight:1000; letter-spacing:.8px; text-transform:uppercase; color:#fff; }

    .panel{
      border-radius:22px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:0;
      height: calc(100% - 40px);
    }

    .list{
      list-style:none; margin:0; padding:0;
      display:flex; flex-direction:column; gap:10px;
      overflow:auto; min-height:0;
    }
    .item{
      border-radius:16px; border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding:10px 10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .item .t{
      font-weight:1000; font-size:13px; letter-spacing:.2px; color:#fff; line-height:1.25;
      overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      text-transform:none;
    }
    .item .m{
      margin-top:6px; display:flex; justify-content:space-between; gap:10px;
      color:var(--muted); font-size:11px; font-weight:900; letter-spacing:.4px; text-transform:uppercase;
    }
    .item a{ color:inherit; text-decoration:none; }
    .empty{
      margin-top:10px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      padding:10px 12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.5px;
      text-transform:uppercase;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }

    .bottom{
      display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap);
      height: 260px; min-height:260px;
    }
    .miniCard .card-inner{ height:100%; display:flex; flex-direction:column; gap:12px; }

    .tvWrap{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      overflow:hidden;
      flex: 1 1 auto;
      min-height: 0;
      position:relative;
    }
    .tvWrap > div{ height:100%; }
    .tvNote{
      color:var(--muted);
      font-size:11px;
      font-weight:900;
      letter-spacing:.5px;
      text-transform:uppercase;
    }

    .wxHero{
      border-radius:22px; border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      padding:12px;
      display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:center;
      flex:1 1 auto;
    }
    .wxTemp{ font-weight:1000; font-size:52px; letter-spacing:-1px; line-height:1; }
    .wxDesc{ margin-top:10px; font-weight:1000; letter-spacing:.6px; text-transform:uppercase; color:#fff; font-size:13px; }
    .wxMeta{ display:flex; flex-direction:column; gap:8px; color:var(--muted); font-weight:900; letter-spacing:.4px; text-transform:uppercase; font-size:12px; }
    .wxRow b{ color:#fff; font-variant-numeric: tabular-nums; }

    .ticker{
      position:absolute; left:0; right:0; bottom:0;
      height: var(--tickerH);
      z-index:3;
      border-top:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.28));
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .tickerTrack{
      height:100%;
      display:flex; align-items:center; gap:48px;
      padding-left:100%;
      animation: scroll 44s linear infinite;
      white-space:nowrap;
      font-weight:1000; letter-spacing:.7px; text-transform:uppercase;
      font-size:14px; color:#fff;
    }
    @keyframes scroll{ 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }
    .tickSep{ opacity:.35; }
    .tickMuted{ color:var(--muted); font-weight:900; }

    @media (max-width: 1200px){
      body{overflow:auto}
      main{ grid-template-columns:1fr; height:auto; }
      .bottom{ grid-template-columns:1fr; height:auto; min-height:0; }
      .ticker{ position:sticky; }
    }
  </style>
</head>

<body>
  <div class="sheen"></div>

  <header>
    <div>
      <div class="title">News Board</div>
      <div class="subline">
        <span class="pill" id="place">Bedford, Nova Scotia</span>
        <span class="pill" id="updated">Updating…</span>
        <span class="pill">Next refresh in <span id="refreshIn">--:--</span></span>
      </div>
    </div>
    <div class="clock" id="clock">
      --:--
      <small id="clockDate">—</small>
    </div>
  </header>

  <main>
    <section class="left">
      <div class="card">
        <div class="card-inner">
          <div class="cardHead">
            <h2>World</h2>
            <span class="pill" id="worldMeta">—</span>
          </div>
          <div class="panel">
            <ul class="list" id="worldList"></ul>
            <div class="empty" id="worldEmpty" style="display:none;"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-inner">
          <div class="cardHead">
            <h2>Local</h2>
            <span class="pill" id="localMeta">—</span>
          </div>
          <div class="panel">
            <ul class="list" id="localList"></ul>
            <div class="empty" id="localEmpty" style="display:none;"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="right">
      <div class="card">
        <div class="card-inner">
          <div class="cardHead">
            <h2>Markets</h2>
            <span class="pill" id="mktMeta">TradingView</span>
          </div>
          <div class="tvNote">If a symbol shows “only available on TradingView”, swap to a TVC:* symbol.</div>
          <div class="tvWrap">
            <div id="tv_widget"></div>
          </div>
        </div>
      </div>

      <div class="bottom">
        <div class="card miniCard">
          <div class="card-inner">
            <div class="cardHead">
              <h2>Top Local</h2>
              <span class="pill" id="mixMeta">—</span>
            </div>
            <div class="panel" style="height: calc(100% - 40px);">
              <ul class="list" id="mixList"></ul>
              <div class="empty" id="mixEmpty" style="display:none;"></div>
            </div>
          </div>
        </div>

        <div class="card miniCard">
          <div class="card-inner">
            <div class="cardHead">
              <h2>Weather</h2>
              <span class="pill" id="wxMeta">—</span>
            </div>
            <div class="wxHero">
              <div>
                <div class="wxTemp"><span id="wxTemp">--</span>°</div>
                <div class="wxDesc" id="wxDesc">Loading…</div>
              </div>
              <div class="wxMeta">
                <div class="wxRow">Feels <b id="wxFeels">--</b>°</div>
                <div class="wxRow">Wind <b id="wxWind">--</b> km/h <b id="wxDir">--</b></div>
                <div class="wxRow">Precip <b id="wxP">--</b> mm</div>
                <div class="wxRow">Hum <b id="wxH">--</b>% • Cloud <b id="wxC">--</b>%</div>
              </div>
            </div>
            <div class="empty" id="wxEmpty" style="display:none;"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="ticker" aria-label="Ticker">
    <div class="tickerTrack" id="tickerTrack">
      <span class="tickMuted">Loading…</span>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const LOCATION = { lat: 44.7326, lon: -63.6533, label: "Bedford, Nova Scotia" };
    const REFRESH_MS = 4 * 60 * 1000;
    let nextRefreshAt = Date.now() + REFRESH_MS;

    // Paste your RSS2JSON key here
    const RSS2JSON_API_KEY = "";

    const FEEDS = {
      world: [
        { name:"BBC World", url:"https://feeds.bbci.co.uk/news/world/rss.xml" },
        { name:"Reuters Top", url:"https://feeds.reuters.com/reuters/topNews" }
      ],
      local: [
        { name:"CBC Nova Scotia", url:"https://rss.cbc.ca/lineup/canada-novascotia.xml" },
        { name:"Global Halifax",  url:"https://globalnews.ca/halifax/feed/" }
      ]
    };

    // ==========================
    // HELPERS
    // ==========================
    const $ = (id) => document.getElementById(id);

    function fmtTime12(d){
      let h = d.getHours();
      const m = String(d.getMinutes()).padStart(2,"0");
      const ap = h >= 12 ? "PM" : "AM";
      h = h % 12; if(h === 0) h = 12;
      return h + ":" + m + ap;
    }
    function fmtDateLine(d){
      return d.toLocaleDateString([], { weekday:"long", month:"short", day:"numeric" }).toUpperCase();
    }
    function tickClock(){
      const d = new Date();
      $("clock").childNodes[0].textContent =
        String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0") + "\n      ";
      $("clockDate").textContent = fmtDateLine(d);
    }
    function tickCountdown(){
      const left = Math.max(0, nextRefreshAt - Date.now());
      const s = Math.floor(left/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      $("refreshIn").textContent = String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function timeAgo(iso){
      const t = Date.parse(iso || "");
      if(!isFinite(t)) return "";
      const s = Math.max(0, Math.floor((Date.now() - t)/1000));
      if(s < 60) return s + "s ago";
      const m = Math.floor(s/60);
      if(m < 60) return m + "m ago";
      const h = Math.floor(m/60);
      if(h < 24) return h + "h ago";
      const d = Math.floor(h/24);
      return d + "d ago";
    }
    async function fetchJson(url){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }
    function setEmpty(which, msg){
      const empty = $(which + "Empty");
      const list = $(which + "List");
      if(msg){
        empty.style.display = "";
        empty.textContent = msg;
        if(list) list.innerHTML = "";
      } else {
        empty.style.display = "none";
      }
    }
    function renderList(listId, items, max){
      const ul = $(listId);
      ul.innerHTML = "";
      items.slice(0, max).forEach(x => {
        const li = document.createElement("li");
        li.className = "item";
        const when = x.pubDate ? timeAgo(x.pubDate) : "";
        li.innerHTML = `
          <a href="${x.link || "#"}" target="_blank" rel="noopener">
            <div class="t">${escapeHtml(x.title || "—")}</div>
            <div class="m">
              <span>${escapeHtml(when || "")}</span>
              <span>${escapeHtml((x.source || "").toUpperCase())}</span>
            </div>
          </a>`;
        ul.appendChild(li);
      });
    }
    function setTicker(parts){
      const track = $("tickerTrack");
      const safe = parts.filter(Boolean);
      const html = safe.map(p => `<span>${escapeHtml(p)}</span>`).join(`<span class="tickSep"> • </span>`);
      const fallback = `<span class="tickMuted">Ticker online • Weather OK • News OK</span>`;
      track.innerHTML = (html || fallback) + `<span class="tickSep"> • </span>` + (html || fallback);
    }

    // ==========================
    // WEATHER (Open-Meteo)
    // ==========================
    function wxText(code){
      const wc = Number(code);
      const map = {
        0:"CLEAR",1:"MOSTLY CLEAR",2:"PARTLY CLOUDY",3:"OVERCAST",45:"FOG",48:"RIME FOG",
        51:"LIGHT DRIZZLE",53:"DRIZZLE",55:"HEAVY DRIZZLE",56:"FREEZING DRIZZLE",57:"HEAVY FREEZING DRIZZLE",
        61:"LIGHT RAIN",63:"RAIN",65:"HEAVY RAIN",66:"FREEZING RAIN",67:"HEAVY FREEZING RAIN",
        71:"LIGHT SNOW",73:"SNOW",75:"HEAVY SNOW",77:"SNOW GRAINS",
        80:"RAIN SHOWERS",81:"SHOWERS",82:"STRONG SHOWERS",
        85:"SNOW SHOWERS",86:"HEAVY SNOW SHOWERS",95:"THUNDERSTORM",96:"T-STORM WITH HAIL",99:"SEVERE T-STORM"
      };
      return map[wc] || ("WEATHER (" + wc + ")");
    }
    function windDirText(deg){
      if(deg==null || isNaN(deg)) return "—";
      const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      return dirs[Math.round(deg/22.5)%16];
    }
    async function loadWeather(){
      const url =
        "https://api.open-meteo.com/v1/forecast?latitude=" + LOCATION.lat + "&longitude=" + LOCATION.lon +
        "&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,wind_speed_10m,wind_direction_10m,weather_code,cloud_cover" +
        "&timezone=auto";
      const data = await fetchJson(url);
      const c = data.current;

      $("wxTemp").textContent  = Math.round(Number(c.temperature_2m || 0));
      $("wxFeels").textContent = Math.round(Number(c.apparent_temperature || 0));
      $("wxH").textContent     = Math.round(Number(c.relative_humidity_2m || 0));
      $("wxC").textContent     = Math.round(Number(c.cloud_cover || 0));
      $("wxP").textContent     = (Number(c.precipitation || 0)).toFixed(1);
      $("wxWind").textContent  = Math.round(Number(c.wind_speed_10m || 0));
      $("wxDir").textContent   = windDirText(c.wind_direction_10m);
      $("wxDesc").textContent  = wxText(c.weather_code);
      $("wxMeta").textContent  = "UPDATED " + fmtTime12(new Date(c.time));
      setEmpty("wx", "");
    }

    // ==========================
    // NEWS (RSS2JSON)
    // ==========================
    function rss2jsonUrl(feedUrl){
      const base = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(feedUrl);
      return RSS2JSON_API_KEY ? (base + "&api_key=" + encodeURIComponent(RSS2JSON_API_KEY)) : base;
    }
    async function loadFeeds(feedList){
      const groups = [];
      for(const f of feedList){
        try{
          const data = await fetchJson(rss2jsonUrl(f.url));
          const items = (data.items || []).map(it => ({
            title: it.title,
            link: it.link,
            pubDate: it.pubDate || it.published || "",
            source: f.name
          })).filter(x => x.title);
          groups.push({ name:f.name, items });
        }catch(e){
          groups.push({ name:f.name, items: [] });
        }
      }
      return groups;
    }
    function mergeAndSort(groups){
      const all = [];
      groups.forEach(g => g.items.forEach(x => all.push(x)));
      all.sort((a,b) => (Date.parse(b.pubDate||"")||0) - (Date.parse(a.pubDate||"")||0));
      const seen = new Set();
      const out = [];
      for(const x of all){
        const key = (x.title||"").toLowerCase();
        if(!key || seen.has(key)) continue;
        seen.add(key);
        out.push(x);
      }
      return out;
    }

    // ==========================
    // MARKETS (TradingView) - fixed symbols
    // ==========================
    function initTradingView(){
      const mount = $("tv_widget");
      mount.innerHTML = "";

      const payload = {
        "symbols": [
          ["S&P 500","TVC:SPX|1D"],
          ["Dow Jones","TVC:DJI|1D"],
          ["Nasdaq 100","NASDAQ:NDX|1D"],
          ["TSX","TSX:TSX|1D"]
        ],
        "chartOnly": false,
        "width": "100%",
        "height": "100%",
        "locale": "en",
        "colorTheme": "dark",
        "autosize": true,
        "showVolume": false,
        "showMA": false,
        "hideDateRanges": false,
        "hideMarketStatus": false,
        "hideSymbolLogo": false,
        "scalePosition": "right",
        "scaleMode": "Normal",
        "fontFamily": "-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif",
        "fontSize": "12",
        "noTimeScale": false,
        "valuesTracking": "1",
        "changeMode": "price-and-percent",
        "chartType": "area",
        "dateRanges": ["1D|1","1M|30","3M|60","12M|1D"]
      };

      const s = document.createElement("script");
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
      s.text = JSON.stringify(payload);
      mount.appendChild(s);
    }

    // ==========================
    // REFRESH LOOP
    // ==========================
    async function refreshAll(){
      const started = Date.now();
      $("updated").textContent = "UPDATING…";

      await loadWeather().catch(() => {
        $("wxMeta").textContent = "NO DATA";
        $("wxDesc").textContent = "UNAVAILABLE";
        setEmpty("wx", "Weather failed to load.");
      });

      const [worldGroups, localGroups] = await Promise.all([
        loadFeeds(FEEDS.world),
        loadFeeds(FEEDS.local)
      ]);

      const world = mergeAndSort(worldGroups);
      const local = mergeAndSort(localGroups);

      if(world.length){
        $("worldMeta").textContent = world.length + " ITEMS";
        setEmpty("world", "");
        renderList("worldList", world, 10);
      } else {
        $("worldMeta").textContent = "NO DATA";
        setEmpty("world", "World news failed. Check RSS2JSON key / rate limits.");
      }

      if(local.length){
        $("localMeta").textContent = local.length + " ITEMS";
        setEmpty("local", "");
        renderList("localList", local, 10);

        $("mixMeta").textContent = Math.min(18, local.length) + " ITEMS";
        setEmpty("mix", "");
        renderList("mixList", local, 18);
      } else {
        $("localMeta").textContent = "NO DATA";
        $("mixMeta").textContent = "NO DATA";
        setEmpty("local", "Local news failed. Check RSS2JSON key / rate limits.");
        setEmpty("mix", "Local news failed (see Local panel).");
      }

      const tickerParts = [];
      tickerParts.push("WORLD: " + (world[0]?.title || "—"));
      tickerParts.push("LOCAL: " + (local[0]?.title || "—"));
      tickerParts.push("WEATHER: " + ($("wxDesc").textContent || "—") + " " + ($("wxTemp").textContent || "--") + "°");
      tickerParts.push("MARKETS: SPX • DJI • NDX • TSX");
      setTicker(tickerParts);

      const took = Math.max(1, Math.round((Date.now() - started)/1000));
      $("updated").textContent = "UPDATED " + fmtTime12(new Date()) + " • " + took + "s";

      nextRefreshAt = Date.now() + REFRESH_MS;
      tickCountdown();
    }

    function start(){
      $("place").textContent = LOCATION.label;

      tickClock(); setInterval(tickClock, 1000);
      tickCountdown(); setInterval(tickCountdown, 1000);

      initTradingView();

      refreshAll().catch(()=>{ $("updated").textContent = "UPDATE FAILED"; });
      setInterval(()=>{ refreshAll().catch(()=>{}); }, REFRESH_MS);
    }

    document.addEventListener("DOMContentLoaded", start);
  </script>
</body>
</html>
