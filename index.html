<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TV Weather Board</title>
  <style>
    :root{
      --bgTop:#061a3a; --bgMid:#0a2a5f; --bgBot:#081833;
      --text:#eaf2ff; --muted:#b9d1ff;
      --border: rgba(255,255,255,.14);
      --shadow: 0 18px 44px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
      --tileRadius: 18px; --cardRadius: 26px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
      --slots: 12;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(54,194,255,.28), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(124,77,255,.22), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(255,176,32,.12), transparent 60%),
        linear-gradient(180deg, var(--bgTop), var(--bgMid) 50%, var(--bgBot));
      overflow:hidden;
    }

    .sheen{
      position:absolute; inset:-60% -60%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.08) 45%, transparent 55%);
      transform: rotate(8deg);
      animation: sweep 14s linear infinite;
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.55;
    }
    @keyframes sweep{
      0%{transform: translateX(-22%) rotate(8deg)}
      100%{transform: translateX(22%) rotate(8deg)}
    }

    header{
      padding:22px 26px 14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      position:relative;
      z-index:2;
    }

    /* Left header area */
    .brand{
      display:flex;
      align-items:flex-end;
      gap:14px;
      min-width: 0;
      flex: 1 1 auto;        /* allows centering across the full left side */
    }

    /* Wrapper for place + pills */
    .brand-content{
      min-width:0;
      width:100%;
    }

    /* BIG location line (centered) */
    .place{
      font-size:34px;
      font-weight:1000;
      letter-spacing:-.6px;
      line-height:1.05;
      text-transform:none;
      color:#fff;
      text-shadow: 0 10px 24px rgba(0,0,0,.35);
      text-align:center;     /* ✅ center the city text */
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      width:100%;
    }

    .subtitle{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      font-weight:800;
      letter-spacing:.6px;
      text-transform:uppercase;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center; /* center pills row to match */
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 12px;border:1px solid var(--border);
      border-radius:999px;background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      font-size:12px;color:var(--muted);font-weight:800;
      letter-spacing:.4px;text-transform:uppercase;white-space:nowrap;
    }

    .clock{
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight:950;font-size:24px;letter-spacing:-.3px;
      text-transform:uppercase;
      flex: 0 0 auto;
    }
    .clock small{
      display:block;margin-top:6px;color:var(--muted);
      font-size:12px;font-weight:850;letter-spacing:.7px;
    }

    main{
      position:relative;z-index:2;
      padding:0 26px 20px;
      height: calc(100% - 96px);
      display:grid;
      grid-template-columns: 1.35fr .95fr;
      gap:16px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius: var(--cardRadius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .card-inner{ padding:18px; }

    .left{display:grid;grid-template-rows:auto auto 1fr;gap:14px;height:100%;}

    .hero{
      background: linear-gradient(135deg, rgba(54,194,255,.16), rgba(124,77,255,.12));
      border:1px solid rgba(255,255,255,.16);
      border-radius: 22px;
      padding:16px;
      box-shadow: var(--shadow2);
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      align-items:stretch;
    }
    .hero-left{display:flex;flex-direction:column;justify-content:space-between;gap:10px;}
    .temp{font-size:86px;font-weight:1000;letter-spacing:-2px;line-height:1;text-shadow: 0 10px 30px rgba(0,0,0,.25);}
    .desc{margin-top:8px;font-size:18px;font-weight:900;letter-spacing:.2px;text-transform:uppercase;color:#fff;}
    .meta{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .chip{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;font-weight:900;letter-spacing:.5px;text-transform:uppercase;
      color:var(--muted);
    }
    .chip b{color:#fff;font-variant-numeric: tabular-nums;}
    .icon-box{
      border-radius: 22px;border:1px solid rgba(255,255,255,.16);
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.16), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.18));
      box-shadow: var(--shadow2);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:12px;gap:10px;
    }
    .icon-wrap{width:120px;height:120px;display:flex;align-items:center;justify-content:center;}
    .feels{font-size:13px;font-weight:900;letter-spacing:.6px;text-transform:uppercase;color:var(--muted);}

    .hourly{
      padding:14px 14px 12px;border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .h-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px;}
    .h-head h2{margin:0;font-size:14px;font-weight:950;letter-spacing:.8px;text-transform:uppercase;color:#fff;}

    .h-strip{
      display:grid;
      grid-template-columns: repeat(var(--slots), 1fr);
      gap:8px;
      padding:10px 10px 6px;
      border-radius:16px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .h-item{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      padding:10px 8px 8px;
      text-align:center;
      min-width:0;
    }
    .h-time{color:var(--muted);font-size:12px;font-weight:900;letter-spacing:.6px;text-transform:uppercase;white-space:nowrap;}
    .h-ico{height:44px;display:flex;align-items:center;justify-content:center;margin:6px 0;}
    .h-temp{font-size:18px;font-weight:1000;font-variant-numeric: tabular-nums;color:#fff;}
    .h-mini{margin-top:4px;font-size:11px;color:var(--muted);font-weight:900;letter-spacing:.4px;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* ======= PRECIP PANEL ======= */
    .precip{
      border-radius:22px;border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.05));
      box-shadow: var(--shadow2);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
    }
    .p-head{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .p-head h2{margin:0;font-size:14px;font-weight:950;letter-spacing:.8px;text-transform:uppercase;color:#fff;}

    .precip-chart{
      display:grid;
      grid-template-columns: 64px 1fr;
      gap:12px;
      align-items:stretch;
    }
    .precip-scale{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      color:var(--muted);
      font-size:10px;
      font-weight:950;
      letter-spacing:.7px;
      text-transform:uppercase;
      padding:8px 0 10px;
      position:relative;
    }
    .precip-scale::after{
      content:"";
      position:absolute;
      right:6px;
      top:6px;
      bottom:8px;
      width:1px;
      background: rgba(255,255,255,.12);
    }

    .bars-wrap{position:relative;}
    .bars{
      display:grid;
      grid-template-columns: repeat(var(--slots), 1fr);
      align-items:end;
      gap:8px;
      height:140px;
      padding:10px 10px 6px;
      border-radius:16px;
      background:
        linear-gradient(to top, rgba(255,255,255,.10) 1px, transparent 1px) 0 100%/100% 28px,
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.06));
      overflow:hidden;
      position:relative;
    }

    /* Remove NOW line */
    #nowLine{ display:none !important; }

    .bar{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
      background: linear-gradient(to top,
        rgba(185,232,255,.85) 0%,
        rgba(90,188,255,.95) 45%,
        rgba(18,106,255,1) 100%
      );
      transform: translateZ(0);
      transition: height 900ms cubic-bezier(.22,1,.36,1), opacity 700ms ease;
      will-change: height, opacity;
    }
    .bar::before{
      content:"";
      position:absolute;
      inset:-40% -60%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.20) 45%, transparent 55%);
      transform: rotate(8deg);
      animation: shimmer 2.4s linear infinite;
      opacity:.55;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    @keyframes shimmer{
      0%{transform: translateX(-30%) rotate(8deg)}
      100%{transform: translateX(30%) rotate(8deg)}
    }
    .bar::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.22), transparent 55%);
      opacity:.85;
      pointer-events:none;
    }

    .bar.trace{ opacity:.06 !important; border-color: rgba(255,255,255,.10); box-shadow:none !important; }
    .bar.trace::before{ animation:none !important; opacity:0 !important; }
    .bar.trace::after{ opacity:.12 !important; }

    .bar-value{
      position:absolute; left:0; right:0; top:6px;
      text-align:center;
      font-size:10px;
      font-weight:1000;
      letter-spacing:.4px;
      color:#ffffff;
      text-shadow: 0 8px 18px rgba(0,0,0,.55);
      opacity:.95;
      pointer-events:none;
    }
    .bar.heavy{ box-shadow: 0 10px 18px rgba(0,0,0,.22), 0 0 22px rgba(90,188,255,.55), 0 0 44px rgba(18,106,255,.35); border-color: rgba(255,255,255,.22); }
    .bar.moderate{ box-shadow: 0 10px 18px rgba(0,0,0,.22), 0 0 16px rgba(90,188,255,.35); border-color: rgba(255,255,255,.18); }

    .bar-labels{
      display:grid;
      grid-template-columns: repeat(var(--slots), 1fr);
      gap:8px;
      margin-top:6px;
      color:var(--muted);
      font-size:10px;
      font-weight:950;
      letter-spacing:.6px;
      text-transform:uppercase;
    }
    .bar-labels span{ text-align:center; min-height:12px; }

    /* ======= RIGHT PANEL ======= */
    .right{height:100%;display:grid;grid-template-rows:1fr auto;gap:16px;min-height:0;}
    .forecast{padding:18px;min-height:0;display:flex;flex-direction:column;gap:12px;}
    .f-head{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .f-head h2{margin:0;font-size:14px;font-weight:950;letter-spacing:.8px;text-transform:uppercase;color:#fff;}
    .f-grid{display:grid;grid-template-columns:1fr;gap:10px;overflow:hidden;flex:1 1 auto;min-height:0;}
    .f-tile{
      border-radius:22px;border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      padding:12px 12px;
      display:grid;grid-template-columns:86px 44px 1fr auto;
      gap:10px;align-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .f-day{font-weight:1000;letter-spacing:.8px;text-transform:uppercase;font-size:13px;color:var(--muted);}
    .f-ico{display:flex;align-items:center;justify-content:center;}
    .f-desc{font-weight:950;font-size:13px;text-transform:uppercase;letter-spacing:.3px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .f-temps{font-weight:1000;font-variant-numeric: tabular-nums;font-size:14px;white-space:nowrap;color:#fff;}
    .f-sub{margin-top:2px;color:var(--muted);font-size:11px;font-weight:900;letter-spacing:.5px;text-transform:uppercase;}

    .stats{
      padding:14px;border-radius:26px;border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(54,194,255,.10), rgba(124,77,255,.08));
      box-shadow: var(--shadow);
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;
    }
    .stat{border-radius:18px;border:1px solid rgba(255,255,255,.16);background: rgba(0,0,0,.14);padding:10px 12px;}
    .stat .k{color:var(--muted);font-size:11px;font-weight:950;letter-spacing:.7px;text-transform:uppercase;}
    .stat .v{margin-top:8px;color:#fff;font-size:18px;font-weight:1000;font-variant-numeric: tabular-nums;}
    .stat .s{margin-top:3px;color:var(--muted);font-size:11px;font-weight:900;letter-spacing:.5px;text-transform:uppercase;}

    footer{
      position:absolute;left:26px;right:26px;bottom:14px;
      display:flex;justify-content:space-between;align-items:center;
      color:var(--muted);font-size:12px;font-weight:900;letter-spacing:.6px;text-transform:uppercase;
      pointer-events:none;z-index:2;
    }

    @media (max-width: 1200px){
      body{overflow:auto}
      main{grid-template-columns: 1fr; height:auto}
      footer{position:static; padding:10px 26px 16px}
      .place{max-width: 100%;}
    }
  </style>
</head>
<body>
  <div class="sheen"></div>

  <header>
    <div class="brand">
      <div class="brand-content">
        <div id="placeLabel" class="place">Locating…</div>
        <div class="subtitle">
          <span class="pill" id="wxUpdated">Updating…</span>
          <span class="pill">Next refresh in <span id="refreshIn">--:--</span></span>
          <span class="pill" id="locMode">LOC: —</span>
        </div>
      </div>
    </div>

    <div class="clock" id="clock">
      --:--
      <small id="clockDate">—</small>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-inner left">

        <div class="hero">
          <div class="hero-left">
            <div>
              <div class="temp"><span id="temp">--</span>°</div>
              <div class="desc" id="wxText">Loading…</div>
              <div class="meta">
                <div class="chip">Feels <b id="apparent">--</b>°</div>
                <div class="chip">Wind <b id="wind">--</b> km/h <b id="windDir">--</b></div>
                <div class="chip">Precip <b id="precip">--</b> mm</div>
              </div>
            </div>
            <div class="pill" id="headline">—</div>
          </div>

          <div class="icon-box">
            <div class="icon-wrap" id="wxIcon" aria-hidden="true"></div>
            <div class="feels">Cloud <b id="cloud">--</b>% • Hum <b id="humidity">--</b>% • UV <b id="uv">--</b> (<span id="uvHint">—</span>)</div>
          </div>
        </div>

        <div class="hourly">
          <div class="h-head">
            <h2>Hourly Outlook</h2>
            <span class="pill">Next <span id="slotCount">12</span> Hours</span>
          </div>
          <div class="h-strip" id="hourly"></div>
        </div>

        <div class="precip">
          <div class="p-head">
            <h2>Precipitation</h2>
            <span class="pill" id="precipMode">mm</span>
          </div>

          <div id="precipBanner" class="pill" style="align-self:flex-start;background:rgba(0,0,0,.18);">—</div>

          <div class="precip-chart">
            <div class="precip-scale">
              <div>HEAVY</div><div>MODERATE</div><div>LIGHT</div>
            </div>

            <div class="bars-wrap">
              <div class="now-line" id="nowLine"></div>
              <div class="bars" id="bars"></div>
              <div class="bar-labels" id="barLabels"></div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section class="card right">
      <div class="forecast">
        <div class="f-head">
          <h2>7-Day Forecast</h2>
          <span class="pill">High / Low</span>
        </div>
        <div class="f-grid" id="forecast"></div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">Gusts</div>
          <div class="v"><span id="gust">--</span> km/h</div>
          <div class="s">Peak gust</div>
        </div>
        <div class="stat">
          <div class="k">Pressure</div>
          <div class="v"><span id="press">--</span> hPa</div>
          <div class="s">Sea level</div>
        </div>
        <div class="stat">
          <div class="k">Today precip</div>
          <div class="v"><span id="todayP">--</span> mm</div>
          <div class="s">Daily total</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div>Powered by Open-Meteo • TV Weather Channel Style</div>
    <div id="status">—</div>
  </footer>

  <script>
    var SLOTS = 12;
    var REFRESH_MS = 5 * 60 * 1000;

    var DRY_THRESHOLD_MM = 0.1;
    var TRACE_HEIGHT_PX = 2;
    var TRACE_OPACITY = 0.06;

    var FALLBACK = { lat: 44.7326, lon: -63.6533, label: "Bedford, Nova Scotia" };
    var LOCATION = { lat: FALLBACK.lat, lon: FALLBACK.lon, label: FALLBACK.label };

    var __svgId = 0;
    var nextRefreshAt = Date.now() + REFRESH_MS;

    function showFatal(err) {
      try { console.error(err); } catch(e) {}
      var div = document.createElement("div");
      div.style.position = "fixed";
      div.style.inset = "0";
      div.style.zIndex = "99999";
      div.style.background = "#0b1a33";
      div.style.color = "white";
      div.style.padding = "18px";
      div.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Arial";
      div.innerHTML =
        '<div style="font-weight:900;font-size:18px;letter-spacing:.4px;text-transform:uppercase;">Weather Board Error</div>' +
        '<div style="opacity:.9;margin-top:10px;font-size:14px;line-height:1.35;">' +
        String(err && err.message ? err.message : err) +
        '</div>';
      document.body.appendChild(div);
    }

    function el(id){
      var node = document.getElementById(id);
      if(!node) throw new Error("Missing element #" + id);
      return node;
    }

    function tickClock(){
      var d = new Date();
      var hh = String(d.getHours()).padStart(2,'0');
      var mm = String(d.getMinutes()).padStart(2,'0');
      el('clock').childNodes[0].textContent = hh + ":" + mm + "\n      ";
      el('clockDate').textContent =
        d.toLocaleDateString([], { weekday:'long', month:'short', day:'numeric' }).toUpperCase();
    }

    function tickCountdown(){
      var left = Math.max(0, nextRefreshAt - Date.now());
      var s = Math.floor(left / 1000);
      var m = Math.floor(s / 60);
      var r = s % 60;
      el("refreshIn").textContent = String(m).padStart(2,'0') + ":" + String(r).padStart(2,'0');
    }

    function applyQueryLocation(){
      try{
        var q = new URLSearchParams(location.search || "");
        var lat = q.get("lat"), lon = q.get("lon"), label = q.get("label");
        if(lat && lon && isFinite(Number(lat)) && isFinite(Number(lon))){
          LOCATION.lat = Number(lat);
          LOCATION.lon = Number(lon);
          if(label) LOCATION.label = String(label);
          el("locMode").textContent = "LOC: URL";
          return true;
        }
      }catch(e){}
      return false;
    }

    function ipGeolocate(){
      el("status").textContent = "LOCATING (IP)…";
      return fetch("https://ipapi.co/json/", { cache: "no-store" })
        .then(function(res){
          if(!res.ok) throw new Error("IP geo failed");
          return res.json();
        })
        .then(function(j){
          if(j && isFinite(Number(j.latitude)) && isFinite(Number(j.longitude))){
            LOCATION.lat = Number(j.latitude);
            LOCATION.lon = Number(j.longitude);

            var parts = [];
            if(j.city) parts.push(j.city);
            if(j.region) parts.push(j.region);
            if(j.country_name) parts.push(j.country_name);
            if(parts.length) LOCATION.label = parts.join(", ");

            el("locMode").textContent = "LOC: IP";
            return true;
          }
          return false;
        })
        .catch(function(){ return false; });
    }

    function nowKeyForOffset(utcOffsetSeconds){
      var ms = Date.now() + Number(utcOffsetSeconds || 0) * 1000;
      var d = new Date(ms);
      var yyyy = d.getUTCFullYear();
      var mm = String(d.getUTCMonth()+1).padStart(2,"0");
      var dd = String(d.getUTCDate()).padStart(2,"0");
      var hh = String(d.getUTCHours()).padStart(2,"0");
      return yyyy + "-" + mm + "-" + dd + "T" + hh;
    }
    function findStartIndex(times, utcOffsetSeconds){
      var key = nowKeyForOffset(utcOffsetSeconds);
      var start = 0;
      for(var i=0;i<times.length;i++){
        if(String(times[i]).slice(0,13) >= key){ start=i; break; }
      }
      return start;
    }

    function svgFor(code, size){
      if(size == null) size = 110;
      __svgId += 1;
      var uid = __svgId;
      var wc = Number(code);

      function base(inner){
        return '<svg width="' + size + '" height="' + size + '" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">' + inner + '</svg>';
      }
      function partlyFallback(){
        return base(
          '<defs>' +
            '<radialGradient id="sun2_' + uid + '" cx="35%" cy="35%" r="70%">' +
              '<stop offset="0" stop-color="#FFF1B0"/>' +
              '<stop offset="1" stop-color="#FFB020"/>' +
            '</radialGradient>' +
            '<linearGradient id="cloud_' + uid + '" x1="0" x2="1">' +
              '<stop offset="0" stop-color="#EAF2FF"/>' +
              '<stop offset="1" stop-color="#BFD8FF"/>' +
            '</linearGradient>' +
          '</defs>' +
          '<circle cx="22" cy="24" r="10" fill="url(#sun2_' + uid + ')"/>' +
          '<g fill="url(#cloud_' + uid + ')">' +
            '<ellipse cx="38" cy="34" rx="18" ry="10"/>' +
            '<ellipse cx="24" cy="38" rx="14" ry="8"/>' +
          '</g>'
        );
      }
      if(!isFinite(wc)) return partlyFallback();

      var fog = {45:1,48:1};
      var drizzle = {51:1,53:1,55:1,56:1,57:1};
      var rain = {61:1,63:1,65:1,66:1,67:1,80:1,81:1,82:1};
      var snow = {71:1,73:1,75:1,77:1,85:1,86:1};
      var thunder = {95:1,96:1,99:1};

      var kind = "clear";
      if(fog[wc]) kind="fog";
      else if(drizzle[wc]) kind="drizzle";
      else if(rain[wc]) kind="rain";
      else if(snow[wc]) kind="snow";
      else if(thunder[wc]) kind="thunder";
      else if(wc===1 || wc===2 || wc===3) kind="partly";

      if(kind==="clear"){
        return base(
          '<defs><radialGradient id="sun_' + uid + '" cx="35%" cy="35%" r="70%">' +
          '<stop offset="0" stop-color="#FFF1B0"/><stop offset="1" stop-color="#FFB020"/></radialGradient></defs>' +
          '<circle cx="32" cy="32" r="14" fill="url(#sun_' + uid + ')"/>' +
          '<g stroke="#FFCF5A" stroke-width="2" stroke-linecap="round" opacity=".95">' +
          '<path d="M32 8v6"/><path d="M32 50v6"/><path d="M8 32h6"/><path d="M50 32h6"/>' +
          '<path d="M14 14l4 4"/><path d="M46 46l4 4"/><path d="M46 18l4-4"/><path d="M14 50l4-4"/>' +
          '</g>'
        );
      }
      if(kind==="partly") return partlyFallback();

      if(kind==="fog"){
        return base(
          '<defs><linearGradient id="fg_' + uid + '" x1="0" x2="1">' +
          '<stop offset="0" stop-color="#EAF2FF"/><stop offset="1" stop-color="#BFD8FF"/></linearGradient></defs>' +
          '<rect x="10" y="14" width="44" height="36" rx="16" fill="url(#fg_' + uid + ')" opacity=".95"/>' +
          '<g fill="#9FB6D8" opacity=".98">' +
          '<rect x="12" y="26" width="40" height="4" rx="2"/>' +
          '<rect x="10" y="34" width="44" height="4" rx="2"/>' +
          '<rect x="14" y="42" width="36" height="4" rx="2"/>' +
          '</g>'
        );
      }

      if(kind==="rain"){
        return base(
          '<defs><linearGradient id="cloud3_' + uid + '" x1="0" x2="1">' +
          '<stop offset="0" stop-color="#EAF2FF"/><stop offset="1" stop-color="#BFD8FF"/></linearGradient>' +
          '<linearGradient id="drop_' + uid + '" x1="0" x2="0" y1="0" y2="1">' +
          '<stop offset="0" stop-color="#36C2FF"/><stop offset="1" stop-color="#2563EB"/></linearGradient></defs>' +
          '<g fill="url(#cloud3_' + uid + ')"><ellipse cx="36" cy="24" rx="18" ry="10"/><ellipse cx="22" cy="28" rx="14" ry="8"/></g>' +
          '<g fill="url(#drop_' + uid + ')">' +
          '<path d="M22 40c0 4-4 6-4 10 0 2 4 4 4 4s4-2 4-4c0-4-4-6-4-10z"/>' +
          '<path d="M34 40c0 4-4 6-4 10 0 2 4 4 4 4s4-2 4-4c0-4-4-6-4-10z"/>' +
          '<path d="M46 40c0 4-4 6-4 10 0 2 4 4 4 4s4-2 4-4c0-4-4-6-4-10z"/>' +
          '</g>'
        );
      }

      if(kind==="snow"){
        return base(
          '<defs><linearGradient id="cloud4_' + uid + '" x1="0" x2="1">' +
          '<stop offset="0" stop-color="#EAF2FF"/><stop offset="1" stop-color="#BFD8FF"/></linearGradient></defs>' +
          '<g fill="url(#cloud4_' + uid + ')"><ellipse cx="36" cy="24" rx="18" ry="10"/><ellipse cx="22" cy="28" rx="14" ry="8"/></g>' +
          '<g fill="#D7F0FF"><circle cx="22" cy="46" r="2.2"/><circle cx="32" cy="50" r="2.2"/><circle cx="42" cy="46" r="2.2"/><circle cx="50" cy="50" r="2.2"/></g>'
        );
      }

      if(kind==="thunder"){
        return base(
          '<defs><linearGradient id="cloud5_' + uid + '" x1="0" x2="1">' +
          '<stop offset="0" stop-color="#EAF2FF"/><stop offset="1" stop-color="#BFD8FF"/></linearGradient>' +
          '<linearGradient id="bolt_' + uid + '" x1="0" x2="0" y1="0" y2="1">' +
          '<stop offset="0" stop-color="#FFE08A"/><stop offset="1" stop-color="#FFB020"/></linearGradient></defs>' +
          '<g fill="url(#cloud5_' + uid + ')"><ellipse cx="36" cy="24" rx="18" ry="10"/><ellipse cx="22" cy="28" rx="14" ry="8"/></g>' +
          '<polygon points="30,38 40,38 32,56 36,44 26,44" fill="url(#bolt_' + uid + ')"/>'
        );
      }

      return partlyFallback();
    }

    function weatherCodeToText(code){
      var wc = Number(code);
      var map = {
        0:"CLEAR",1:"MOSTLY CLEAR",2:"PARTLY CLOUDY",3:"OVERCAST",45:"FOG",48:"RIME FOG",
        51:"LIGHT DRIZZLE",53:"DRIZZLE",55:"HEAVY DRIZZLE",56:"FREEZING DRIZZLE",57:"HEAVY FREEZING DRIZZLE",
        61:"LIGHT RAIN",63:"RAIN",65:"HEAVY RAIN",66:"FREEZING RAIN",67:"HEAVY FREEZING RAIN",
        71:"LIGHT SNOW",73:"SNOW",75:"HEAVY SNOW",77:"SNOW GRAINS",
        80:"RAIN SHOWERS",81:"SHOWERS",82:"STRONG SHOWERS",
        85:"SNOW SHOWERS",86:"HEAVY SNOW SHOWERS",95:"THUNDERSTORM",96:"T-STORM WITH HAIL",99:"SEVERE T-STORM"
      };
      return map[wc] || ("WEATHER (" + wc + ")");
    }

    function dayLabel(isoDate){
      return new Date(isoDate + "T00:00:00").toLocaleDateString([], {weekday:"short"}).toUpperCase();
    }

    function windDirText(deg){
      if(deg==null || isNaN(deg)) return "—";
      var dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      return dirs[Math.round(deg/22.5)%16];
    }

    function uvHint(uv){
      if(uv==null||isNaN(uv)) return "—";
      if(uv<3) return "LOW";
      if(uv<6) return "MOD";
      if(uv<8) return "HIGH";
      if(uv<11) return "V HIGH";
      return "EXTREME";
    }

    function headlineFor(c){
      var code = Number(c.weather_code);
      var wind = Number(c.wind_speed_10m || 0);
      var precip = Number(c.precipitation || 0);

      if(code===95 || code===96 || code===99) return "ALERT: THUNDERSTORM CONDITIONS";
      if(precip>=2) return "WET ROADS: MODERATE RAIN POSSIBLE";
      if(code===71 || code===73 || code===75 || code===85 || code===86) return "WINTRY: SNOW SHOWERS IN THE AREA";
      if(code===45 || code===48) return "VISIBILITY: PATCHY FOG";
      if(wind>=35) return "BREEZY: GUSTY WINDS EXPECTED";
      if(code===0) return "CLEAR SKIES: GREAT CONDITIONS";
      return "WEATHER UPDATE: STAY PREPARED";
    }

    function renderForecast(data){
      var out = el("forecast");
      out.innerHTML = "";

      var times = data.daily.time;
      var tmax  = data.daily.temperature_2m_max;
      var tmin  = data.daily.temperature_2m_min;
      var code  = data.daily.weather_code;
      var psum  = data.daily.precipitation_sum;

      for(var i=0;i<Math.min(7,times.length);i++){
        var tile = document.createElement("div");
        tile.className = "f-tile";
        tile.innerHTML =
          '<div>' +
            '<div class="f-day">' + dayLabel(times[i]) + '</div>' +
            '<div class="f-sub">P ' + (Number(psum[i] || 0)).toFixed(1) + ' mm</div>' +
          '</div>' +
          '<div class="f-ico">' + svgFor(code[i], 36) + '</div>' +
          '<div>' +
            '<div class="f-desc">' + weatherCodeToText(code[i]) + '</div>' +
            '<div class="f-sub">' + ((Number(psum[i] || 0)) > 1 ? "WET PERIOD" : "LOW PRECIP") + '</div>' +
          '</div>' +
          '<div class="f-temps">' + Math.round(Number(tmax[i] || 0)) + '° / ' + Math.round(Number(tmin[i] || 0)) + '°</div>';

        out.appendChild(tile);
      }
    }

    function renderHourly(data){
      var hourlyEl = el("hourly");
      hourlyEl.innerHTML = "";

      var times = (data.hourly && data.hourly.time) ? data.hourly.time : [];
      var temp  = (data.hourly && data.hourly.temperature_2m) ? data.hourly.temperature_2m : [];
      var code  = (data.hourly && data.hourly.weather_code) ? data.hourly.weather_code : [];
      var precipMM = (data.hourly && data.hourly.precipitation) ? data.hourly.precipitation : [];

      var utcOffset = Number(data.utc_offset_seconds || 0);
      var start = findStartIndex(times, utcOffset);

      for(var i = start; i < Math.min(start + SLOTS, times.length); i++){
        var t = new Date(times[i]);
        var label = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        var pmm = Number((precipMM && precipMM[i] != null) ? precipMM[i] : 0);
        var mini = "P " + (Math.round(pmm*10)/10).toFixed(1) + " mm";

        var item = document.createElement("div");
        item.className = "h-item";
        item.innerHTML =
          '<div class="h-time">' + label + '</div>' +
          '<div class="h-ico">' + svgFor(code[i], 40) + '</div>' +
          '<div class="h-temp">' + Math.round(Number(temp[i] || 0)) + '°</div>' +
          '<div class="h-mini">' + mini + '</div>';

        hourlyEl.appendChild(item);
      }

      var bars   = el("bars");
      var labels = el("barLabels");
      var banner = el("precipBanner");
      var mode   = el("precipMode");
      var nowLine = document.getElementById("nowLine");

      bars.innerHTML = "";
      labels.innerHTML = "";
      mode.textContent = "mm";
      if(nowLine) nowLine.style.display = "none";

      var series = (Array.isArray(precipMM) && precipMM.length)
        ? precipMM.map(function(v){ return Number(v || 0); })
        : null;

      if(!series){
        banner.textContent = "PRECIP DATA NOT AVAILABLE";
        return;
      }

      var slice = [];
      for (var j = start; j < Math.min(start + SLOTS, times.length); j++) slice.push(Number(series[j] || 0));
      while (slice.length < SLOTS) slice.push(0);

      var max = 0;
      for (var m = 0; m < slice.length; m++){
        var v = slice[m];
        if (v >= DRY_THRESHOLD_MM && v > max) max = v;
      }
      if(max <= 0) max = DRY_THRESHOLD_MM;

      var shownMax = 0;
      for (var mm2 = 0; mm2 < slice.length; mm2++) if (slice[mm2] > shownMax) shownMax = slice[mm2];
      banner.textContent = "MAX " + (Math.round(shownMax*10)/10).toFixed(1) + " MM (NEXT " + SLOTS + "H)";

      var toAnimate = [];

      for(var k=0; k<SLOTS; k++){
        var rawVal = Number(slice[k] || 0);
        var isTrace = rawVal < DRY_THRESHOLD_MM;

        var targetH = isTrace
          ? TRACE_HEIGHT_PX
          : Math.min(140, Math.max(10, Math.round((rawVal / max) * 120)));

        var b = document.createElement("div");
        b.className = "bar";

        if(isTrace){
          b.classList.add("trace");
          b.style.opacity = String(TRACE_OPACITY);
        } else {
          if(rawVal >= 3) b.classList.add("heavy");
          else if(rawVal >= 1) b.classList.add("moderate");
        }

        b.style.height = "0px";
        b.innerHTML = '<div class="bar-value">' + (isTrace ? "" : (Math.round(rawVal*10)/10).toFixed(1)) + '</div>';
        bars.appendChild(b);
        toAnimate.push({ el: b, h: targetH });

        var idx = start + k;
        var lab = document.createElement("span");
        if(idx < times.length){
          var tt = new Date(times[idx]);
          var hr = tt.getHours();
          var ampm = hr >= 12 ? "pm" : "am";
          hr = hr % 12; if(hr === 0) hr = 12;
          lab.textContent = (k % 2 === 0) ? (hr + ":00" + ampm) : "";
        } else {
          lab.textContent = (k % 2 === 0) ? "--" : "";
        }
        labels.appendChild(lab);
      }

      setTimeout(function(){
        for(var n=0; n<toAnimate.length; n++){
          toAnimate[n].el.style.height = String(toAnimate[n].h) + "px";
        }
      }, 60);
    }

    function loadWeather(){
      el("placeLabel").textContent = LOCATION.label;

      var url =
        "https://api.open-meteo.com/v1/forecast?latitude=" + encodeURIComponent(LOCATION.lat) +
        "&longitude=" + encodeURIComponent(LOCATION.lon) +
        "&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,wind_speed_10m,wind_direction_10m,wind_gusts_10m,weather_code,cloud_cover,uv_index,pressure_msl" +
        "&hourly=temperature_2m,weather_code,precipitation,precipitation_probability" +
        "&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum" +
        "&timezone=auto";

      return fetch(url, {cache:"no-store"})
        .then(function(res){
          if(!res.ok) throw new Error("Weather fetch failed");
          return res.json();
        })
        .then(function(data){
          var c = data.current;

          el("temp").textContent = Math.round(Number(c.temperature_2m || 0));
          el("apparent").textContent = Math.round(Number(c.apparent_temperature || 0));
          el("wind").textContent = Math.round(Number(c.wind_speed_10m || 0));
          el("windDir").textContent = windDirText(c.wind_direction_10m);
          el("precip").textContent = (Number(c.precipitation || 0)).toFixed(1);

          el("humidity").textContent = Math.round(Number(c.relative_humidity_2m || 0));
          el("cloud").textContent = Math.round(Number(c.cloud_cover || 0));
          el("uv").textContent = (Number(c.uv_index || 0)).toFixed(1);
          el("uvHint").textContent = uvHint(c.uv_index);

          el("wxText").textContent = weatherCodeToText(c.weather_code);
          el("wxIcon").innerHTML = svgFor(c.weather_code, 118);
          el("headline").textContent = headlineFor(c);

          var updated = new Date(c.time);
          el("wxUpdated").textContent = "UPDATED " + updated.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

          renderHourly(data);
          renderForecast(data);

          el("status").textContent = "ONLINE";
          nextRefreshAt = Date.now() + REFRESH_MS;
          tickCountdown();
        });
    }

    function start(){
      try{
        document.documentElement.style.setProperty('--slots', String(SLOTS));
        el('slotCount').textContent = String(SLOTS);

        tickClock(); setInterval(tickClock, 1000);
        tickCountdown(); setInterval(tickCountdown, 1000);

        el("locMode").textContent = "LOC: —";
        var usedUrl = applyQueryLocation();
        if(usedUrl){
          el("status").textContent = "USING URL LOCATION";
          el("placeLabel").textContent = LOCATION.label;
          loadWeather().catch(showFatal);
        } else {
          ipGeolocate().then(function(ok){
            if(!ok){
              LOCATION.lat = FALLBACK.lat; LOCATION.lon = FALLBACK.lon; LOCATION.label = FALLBACK.label;
              el("locMode").textContent = "LOC: FALLBACK";
            }
            el("placeLabel").textContent = LOCATION.label;
            return loadWeather();
          }).catch(showFatal);
        }

        setInterval(function(){ loadWeather().catch(function(){}); }, REFRESH_MS);
      }catch(e){
        showFatal(e);
      }
    }

    document.addEventListener("DOMContentLoaded", start);
  </script>
</body>
</html>
