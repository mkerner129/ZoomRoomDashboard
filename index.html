<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Broadcast News Board</title>
  <style>
    :root{
      --bg1:#061a3a; --bg2:#0a2a5f; --bg3:#081833;
      --text:#eaf2ff; --muted:#b9d1ff; --border: rgba(255,255,255,.14);
      --shadow: 0 18px 44px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
      --radius: 26px; --gap: 16px;
      --tickerH: 64px;
      --breakingH: 56px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;

      --accent1: rgba(54,194,255,.95);
      --accent2: rgba(124,77,255,.92);
      --warn1: rgba(255,64,64,.95);
      --warn2: rgba(255,176,32,.95);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(54,194,255,.28), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(124,77,255,.22), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(255,176,32,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 50%, var(--bg3));
      overflow:hidden;
    }

    .sheen{
      position:absolute; inset:-60% -60%;
      background: linear-gradient(120deg,
        transparent 35%,
        rgba(255,255,255,.08) 45%,
        transparent 55%);
      transform: rotate(8deg);
      animation: sweep 14s linear infinite;
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.55;
    }
    @keyframes sweep{
      0%{transform: translateX(-22%) rotate(8deg)}
      100%{transform: translateX(22%) rotate(8deg)}
    }

    /* ====== TOP BAR ====== */
    header{
      position:relative; z-index:3;
      padding:18px 22px 10px;
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end;
    }
    .brand{
      display:flex; flex-direction:column; gap:10px;
    }
    .title{
      font-weight:1100; letter-spacing:-.8px; font-size:32px; line-height:1;
      text-transform:uppercase;
      text-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .subline{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color:var(--muted); text-transform:uppercase; letter-spacing:.6px;
      font-weight:900; font-size:12px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border:1px solid var(--border);
      border-radius:999px; background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      font-size:12px; color:var(--muted); font-weight:900;
      letter-spacing:.4px; text-transform:uppercase; white-space:nowrap;
    }
    .clock{
      text-align:right; font-variant-numeric: tabular-nums;
      font-weight:1100; letter-spacing:-.2px; font-size:26px;
      text-transform:uppercase;
    }
    .clock small{
      display:block; margin-top:6px; color:var(--muted);
      font-size:12px; font-weight:900; letter-spacing:.7px;
    }

    /* ====== BREAKING BAR ====== */
    .breaking{
      position:absolute; left:0; right:0;
      top:86px; /* just below header */
      height: var(--breakingH);
      z-index:4;
      display:none;
      align-items:center;
      border-top:1px solid rgba(255,255,255,.12);
      border-bottom:1px solid rgba(255,255,255,.12);
      background:
        linear-gradient(90deg, rgba(255,64,64,.85), rgba(255,176,32,.55) 60%, rgba(255,64,64,.78));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .breaking.on{display:flex}
    .breakingTag{
      min-width: 182px;
      height:100%;
      display:flex; align-items:center; justify-content:center;
      font-weight:1100;
      letter-spacing:1.3px;
      text-transform:uppercase;
      background: rgba(0,0,0,.22);
      border-right:1px solid rgba(255,255,255,.18);
    }
    .breakingTrack{
      height:100%;
      display:flex; align-items:center;
      white-space:nowrap;
      padding-left:100%;
      animation: scroll 22s linear infinite;
      font-weight:1050;
      letter-spacing:.6px;
      text-transform:uppercase;
      font-size:16px;
      color:#fff;
      text-shadow: 0 10px 18px rgba(0,0,0,.35);
      gap:48px;
    }
    .breakingSep{opacity:.45}
    @keyframes scroll{ 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }

    /* ====== MAIN LAYOUT ====== */
    main{
      position:relative; z-index:2;
      padding:0 22px 16px;
      height: calc(100% - 86px - var(--tickerH));
      display:grid;
      grid-template-columns: 1.55fr .95fr;
      gap: var(--gap);
      min-height:0;
      margin-top: calc(var(--breakingH) + 10px); /* room for breaking bar even when hidden */
    }
    .breaking:not(.on) ~ main{
      margin-top: 0;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      min-height:0;
    }
    .card-inner{ padding:16px; min-height:0; height:100%; }

    /* Left column: Hero + lists */
    .leftCol{
      display:grid;
      grid-template-rows: 1.05fr .95fr;
      gap: var(--gap);
      height:100%;
      min-height:0;
    }

    /* Hero panel */
    .hero{
      position:relative;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(900px 500px at 20% 20%, rgba(54,194,255,.18), transparent 55%),
        radial-gradient(700px 500px at 80% 30%, rgba(124,77,255,.14), transparent 55%),
        rgba(0,0,0,.16);
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:12px;
      height:100%;
      min-height:0;
    }
    .heroMedia{
      position:relative;
      border-right:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      min-height:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), transparent 60%),
        linear-gradient(135deg, rgba(54,194,255,.35), rgba(124,77,255,.25));
    }
    .heroImg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      opacity:.88;
      transform: scale(1.03);
      filter: contrast(1.05) saturate(1.05);
    }
    .heroOverlay{
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.10) 55%, rgba(0,0,0,.35)),
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.65));
    }
    .heroBug{
      position:absolute; top:14px; left:14px;
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      font-size:12px; font-weight:1000; letter-spacing:.7px; text-transform:uppercase;
      color:#fff;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      box-shadow: 0 0 14px rgba(54,194,255,.35);
    }
    .heroText{
      padding:16px 16px 14px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
      min-height:0;
    }
    .heroTitle{
      font-weight:1100;
      font-size:34px;
      letter-spacing:-.7px;
      line-height:1.07;
      text-transform:none;
      text-shadow: 0 14px 26px rgba(0,0,0,.35);
      overflow:hidden;
      display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical;
    }
    .heroDeck{
      margin-top:10px;
      color:rgba(234,242,255,.92);
      font-size:14px;
      font-weight:900;
      letter-spacing:.25px;
      line-height:1.3;
      overflow:hidden;
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
      opacity:.95;
    }
    .heroMeta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      font-weight:1000;
      letter-spacing:.6px;
      text-transform:uppercase;
    }
    .heroMeta a{color:inherit; text-decoration:none}
    .heroKicker{
      display:flex; gap:8px; align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-weight:1000;
      letter-spacing:.7px;
      text-transform:uppercase;
      font-size:11px;
      color:#fff;
      white-space:nowrap;
    }
    .badge.breaking{
      background: linear-gradient(135deg, rgba(255,64,64,.92), rgba(255,176,32,.75));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 0 22px rgba(255,64,64,.22);
    }

    /* Lists row */
    .lists{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      height:100%;
      min-height:0;
    }
    .cardHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .cardHead h2{
      margin:0; font-size:14px; font-weight:1100;
      letter-spacing:.9px; text-transform:uppercase; color:#fff;
    }
    .panel{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      padding:12px;
      display:flex;
      flex-direction:column;
      min-height:0;
      height: calc(100% - 36px);
    }
    ul.list{
      list-style:none; margin:0; padding:0;
      display:flex; flex-direction:column; gap:10px;
      overflow:auto; min-height:0;
    }
    .item{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding:10px 10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
    }
    .item .t{
      font-weight:1050;
      font-size:13px;
      letter-spacing:.2px;
      color:#fff;
      line-height:1.25;
      overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
    }
    .item .m{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:11px;
      font-weight:950;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    .item a{ color:inherit; text-decoration:none; }
    .empty{
      margin-top:10px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.10);
      padding:10px 12px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:.5px;
      text-transform:uppercase;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }

    /* Right column: markets + weather + top local */
    .rightCol{
      display:grid;
      grid-template-rows: 1fr auto;
      gap: var(--gap);
      height:100%;
      min-height:0;
    }
    .stack{
      display:grid;
      grid-template-rows: 1.1fr .9fr;
      gap: var(--gap);
      min-height:0;
    }

    .tvNote{
      color:var(--muted);
      font-size:11px;
      font-weight:950;
      letter-spacing:.5px;
      text-transform:uppercase;
      margin-bottom:10px;
    }
    .tvWrap{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      overflow:hidden;
      min-height:0;
      height: calc(100% - 46px);
    }
    .tvWrap > div{ height:100%; }

    .wxBox{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(700px 260px at 30% 10%, rgba(54,194,255,.16), transparent 60%),
        radial-gradient(700px 260px at 70% 10%, rgba(124,77,255,.12), transparent 60%),
        rgba(0,0,0,.14);
      box-shadow: var(--shadow2);
      padding:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
      height: calc(100% - 36px);
    }
    .wxTemp{ font-weight:1150; font-size:54px; letter-spacing:-1px; line-height:1; }
    .wxDesc{ margin-top:10px; font-weight:1100; letter-spacing:.7px; text-transform:uppercase; color:#fff; font-size:13px; }
    .wxMeta{
      display:flex; flex-direction:column; gap:8px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:.4px;
      text-transform:uppercase;
      font-size:12px;
    }
    .wxRow b{ color:#fff; font-variant-numeric: tabular-nums; }

    /* ====== BOTTOM TICKER ====== */
    .ticker{
      position:absolute; left:0; right:0; bottom:0;
      height: var(--tickerH);
      z-index:5;
      border-top:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.30));
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .tickerTag{
      position:absolute; left:0; top:0; bottom:0;
      width:160px;
      display:flex; align-items:center; justify-content:center;
      font-weight:1100; letter-spacing:1.1px; text-transform:uppercase;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), transparent 60%),
        linear-gradient(135deg, rgba(54,194,255,.85), rgba(124,77,255,.78));
      border-right:1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 26px rgba(0,0,0,.25);
    }
    .tickerTrack{
      height:100%;
      display:flex; align-items:center; gap:56px;
      padding-left: calc(160px + 100%);
      animation: scroll2 44s linear infinite;
      white-space:nowrap;
      font-weight:1100; letter-spacing:.7px; text-transform:uppercase;
      font-size:15px; color:#fff;
    }
    .tickMuted{ color:var(--muted); font-weight:950; }
    .tickSep{ opacity:.35; }
    @keyframes scroll2{ 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }

    @media (max-width: 1200px){
      body{overflow:auto}
      .breaking{position:sticky; top:0}
      main{grid-template-columns:1fr; height:auto}
      .lists{grid-template-columns:1fr}
      .stack{grid-template-rows:auto auto}
      .ticker{position:sticky}
    }
  </style>
</head>

<body>
  <div class="sheen"></div>

  <header>
    <div class="brand">
      <div class="title">Broadcast News</div>
      <div class="subline">
        <span class="pill" id="place">Bedford, Nova Scotia</span>
        <span class="pill" id="updated">Updating…</span>
        <span class="pill">Next refresh in <span id="refreshIn">--:--</span></span>
        <span class="pill">Rotation <span id="rotIn">--</span>s</span>
      </div>
    </div>

    <div class="clock" id="clock">
      --:--
      <small id="clockDate">—</small>
    </div>
  </header>

  <!-- BREAKING -->
  <div class="breaking" id="breakingBar" aria-label="Breaking News">
    <div class="breakingTag">BREAKING</div>
    <div class="breakingTrack" id="breakingTrack">
      <span>—</span>
    </div>
  </div>

  <main>
    <!-- LEFT -->
    <section class="card">
      <div class="card-inner leftCol">

        <!-- HERO -->
        <div class="hero">
          <div class="heroMedia">
            <img id="heroImg" class="heroImg" alt="" style="display:none;" />
            <div class="heroOverlay"></div>
            <div class="heroBug">
              <span class="dot"></span>
              <span id="heroSource">TOP STORY</span>
            </div>
          </div>

          <div class="heroText">
            <div>
              <div class="heroKicker">
                <span class="badge" id="heroSection">WORLD</span>
                <span class="badge" id="heroAge">—</span>
                <span class="badge breaking" id="heroBreaking" style="display:none;">BREAKING</span>
              </div>

              <div class="heroTitle" id="heroTitle">Loading…</div>
              <div class="heroDeck" id="heroDeck">Fetching latest headlines…</div>
            </div>

            <div class="heroMeta">
              <div>
                <a href="#" id="heroLink" target="_blank" rel="noopener">OPEN STORY</a>
              </div>
              <div id="heroUpdated">—</div>
            </div>
          </div>
        </div>

        <!-- LISTS -->
        <div class="lists">
          <div class="card">
            <div class="card-inner">
              <div class="cardHead">
                <h2>World</h2>
                <span class="pill" id="worldMeta">—</span>
              </div>
              <div class="panel">
                <ul class="list" id="worldList"></ul>
                <div class="empty" id="worldEmpty" style="display:none;"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-inner">
              <div class="cardHead">
                <h2>Local</h2>
                <span class="pill" id="localMeta">—</span>
              </div>
              <div class="panel">
                <ul class="list" id="localList"></ul>
                <div class="empty" id="localEmpty" style="display:none;"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="card-inner rightCol">
        <div class="stack">

          <!-- MARKETS -->
          <div class="card">
            <div class="card-inner" style="height:100%;">
              <div class="cardHead">
                <h2>Markets</h2>
                <span class="pill">TradingView</span>
              </div>
              <div class="tvNote">OANDA CFD symbols for embed compatibility</div>
              <div class="tvWrap">
                <div id="tv_widget"></div>
              </div>
            </div>
          </div>

          <!-- WEATHER + TOP LOCAL -->
          <div class="card">
            <div class="card-inner" style="height:100%; display:grid; grid-template-rows:auto 1fr; gap:10px;">
              <div class="cardHead">
                <h2>Weather</h2>
                <span class="pill" id="wxMeta">—</span>
              </div>
              <div class="wxBox">
                <div>
                  <div class="wxTemp"><span id="wxTemp">--</span>°</div>
                  <div class="wxDesc" id="wxDesc">Loading…</div>
                </div>
                <div class="wxMeta">
                  <div class="wxRow">Feels <b id="wxFeels">--</b>°</div>
                  <div class="wxRow">Wind <b id="wxWind">--</b> km/h <b id="wxDir">--</b></div>
                  <div class="wxRow">Precip <b id="wxP">--</b> mm</div>
                  <div class="wxRow">Hum <b id="wxH">--</b>% • Cloud <b id="wxC">--</b>%</div>
                </div>
              </div>
              <div class="empty" id="wxEmpty" style="display:none;"></div>
            </div>
          </div>

        </div>

        <!-- TOP LOCAL (compact) -->
        <div class="card">
          <div class="card-inner">
            <div class="cardHead">
              <h2>Top Local</h2>
              <span class="pill" id="mixMeta">—</span>
            </div>
            <div class="panel">
              <ul class="list" id="mixList"></ul>
              <div class="empty" id="mixEmpty" style="display:none;"></div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- TICKER -->
  <div class="ticker" aria-label="News Ticker">
    <div class="tickerTag">LIVE</div>
    <div class="tickerTrack" id="tickerTrack">
      <span class="tickMuted">Loading…</span>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const LOCATION = { lat: 44.7326, lon: -63.6533, label: "Bedford, Nova Scotia" };
    const REFRESH_MS = 4 * 60 * 1000;

    // Headline rotation interval (seconds)
    const ROTATE_S = 12;

    // Paste your RSS2JSON API key here (recommended)
    const RSS2JSON_API_KEY = ""; // e.g. "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

    // RSS feeds
    const FEEDS = {
      world: [
        { name:"BBC World", url:"https://feeds.bbci.co.uk/news/world/rss.xml" },
        { name:"Reuters Top", url:"https://feeds.reuters.com/reuters/topNews" }
      ],
      local: [
        { name:"CBC Nova Scotia", url:"https://rss.cbc.ca/lineup/canada-novascotia.xml" },
        { name:"Global Halifax",  url:"https://globalnews.ca/halifax/feed/" }
      ]
    };

    // TradingView symbols (embed-friendly)
    const MARKET_SYMBOLS = [
      ["S&P 500 (CFD)","OANDA:SPX500USD|1D"],
      ["US 30 (CFD)","OANDA:US30USD|1D"],
      ["Nasdaq 100 (CFD)","OANDA:NAS100USD|1D"],
      ["TSX","TSX:TSX|1D"]
    ];

    // ==========================
    // STATE
    // ==========================
    let nextRefreshAt = Date.now() + REFRESH_MS;
    let rotateIn = ROTATE_S;
    let worldItems = [];
    let localItems = [];
    let heroIndex = 0;
    let heroMode = "world"; // alternate world/local on rotate
    let breakingItems = [];

    // ==========================
    // HELPERS
    // ==========================
    const $ = (id) => document.getElementById(id);

    function fmtTime12(d){
      let h = d.getHours();
      const m = String(d.getMinutes()).padStart(2,"0");
      const ap = h >= 12 ? "PM" : "AM";
      h = h % 12; if(h === 0) h = 12;
      return h + ":" + m + ap;
    }
    function fmtDateLine(d){
      return d.toLocaleDateString([], { weekday:"long", month:"short", day:"numeric" }).toUpperCase();
    }
    function tickClock(){
      const d = new Date();
      $("clock").childNodes[0].textContent =
        String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0") + "\n      ";
      $("clockDate").textContent = fmtDateLine(d);
    }
    function tickCountdown(){
      const left = Math.max(0, nextRefreshAt - Date.now());
      const s = Math.floor(left/1000);
      const m = Math.floor(s/60);
      const r = s % 60;
      $("refreshIn").textContent = String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function timeAgo(iso){
      const t = Date.parse(iso || "");
      if(!isFinite(t)) return "";
      const s = Math.max(0, Math.floor((Date.now() - t)/1000));
      if(s < 60) return s + "s ago";
      const m = Math.floor(s/60);
      if(m < 60) return m + "m ago";
      const h = Math.floor(m/60);
      if(h < 24) return h + "h ago";
      const d = Math.floor(h/24);
      return d + "d ago";
    }
    async function fetchJson(url){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }
    function setEmpty(which, msg){
      const empty = $(which + "Empty");
      const list = $(which + "List");
      if(msg){
        empty.style.display = "";
        empty.textContent = msg;
        if(list) list.innerHTML = "";
      } else {
        empty.style.display = "none";
      }
    }
    function renderList(listId, items, max){
      const ul = $(listId);
      ul.innerHTML = "";
      items.slice(0, max).forEach(x => {
        const li = document.createElement("li");
        li.className = "item";
        const when = x.pubDate ? timeAgo(x.pubDate) : "";
        li.innerHTML = `
          <a href="${x.link || "#"}" target="_blank" rel="noopener">
            <div class="t">${escapeHtml(x.title || "—")}</div>
            <div class="m">
              <span>${escapeHtml(when || "")}</span>
              <span>${escapeHtml((x.source || "").toUpperCase())}</span>
            </div>
          </a>`;
        ul.appendChild(li);
      });
    }
    function rss2jsonUrl(feedUrl){
      const base = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(feedUrl);
      return RSS2JSON_API_KEY ? (base + "&api_key=" + encodeURIComponent(RSS2JSON_API_KEY)) : base;
    }
    function bestImage(it){
      // RSS2JSON often has enclosure.link, thumbnail, or may embed media in description.
      const enc = it && it.enclosure && it.enclosure.link ? it.enclosure.link : "";
      if(enc && /^https?:\/\//i.test(enc)) return enc;

      const thumb = it && it.thumbnail ? it.thumbnail : "";
      if(thumb && /^https?:\/\//i.test(thumb)) return thumb;

      const desc = it && it.description ? it.description : "";
      const m = /<img[^>]+src=["']([^"']+)["']/i.exec(desc);
      if(m && m[1] && /^https?:\/\//i.test(m[1])) return m[1];

      return "";
    }
    function stripHtml(html){
      const tmp = document.createElement("div");
      tmp.innerHTML = html || "";
      const text = (tmp.textContent || tmp.innerText || "").trim();
      return text.replace(/\s+/g," ");
    }
    function isBreakingItem(x){
      const t = (x.title || "").toLowerCase();
      const s = (x.source || "").toLowerCase();
      const d = (x.description || "").toLowerCase();
      return t.includes("breaking") || t.includes("urgent") || t.includes("live:") ||
             d.includes("breaking") || d.includes("urgent") ||
             s.includes("breaking");
    }

    // ==========================
    // WEATHER (Open-Meteo)
    // ==========================
    function wxText(code){
      const wc = Number(code);
      const map = {
        0:"CLEAR",1:"MOSTLY CLEAR",2:"PARTLY CLOUDY",3:"OVERCAST",45:"FOG",48:"RIME FOG",
        51:"LIGHT DRIZZLE",53:"DRIZZLE",55:"HEAVY DRIZZLE",56:"FREEZING DRIZZLE",57:"HEAVY FREEZING DRIZZLE",
        61:"LIGHT RAIN",63:"RAIN",65:"HEAVY RAIN",66:"FREEZING RAIN",67:"HEAVY FREEZING RAIN",
        71:"LIGHT SNOW",73:"SNOW",75:"HEAVY SNOW",77:"SNOW GRAINS",
        80:"RAIN SHOWERS",81:"SHOWERS",82:"STRONG SHOWERS",
        85:"SNOW SHOWERS",86:"HEAVY SNOW SHOWERS",95:"THUNDERSTORM",96:"T-STORM WITH HAIL",99:"SEVERE T-STORM"
      };
      return map[wc] || ("WEATHER (" + wc + ")");
    }
    function windDirText(deg){
      if(deg==null || isNaN(deg)) return "—";
      const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      return dirs[Math.round(deg/22.5)%16];
    }
    async function loadWeather(){
      const url =
        "https://api.open-meteo.com/v1/forecast?latitude=" + LOCATION.lat + "&longitude=" + LOCATION.lon +
        "&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,wind_speed_10m,wind_direction_10m,weather_code,cloud_cover" +
        "&timezone=auto";
      const data = await fetchJson(url);
      const c = data.current;

      $("wxTemp").textContent  = Math.round(Number(c.temperature_2m || 0));
      $("wxFeels").textContent = Math.round(Number(c.apparent_temperature || 0));
      $("wxH").textContent     = Math.round(Number(c.relative_humidity_2m || 0));
      $("wxC").textContent     = Math.round(Number(c.cloud_cover || 0));
      $("wxP").textContent     = (Number(c.precipitation || 0)).toFixed(1);
      $("wxWind").textContent  = Math.round(Number(c.wind_speed_10m || 0));
      $("wxDir").textContent   = windDirText(c.wind_direction_10m);
      $("wxDesc").textContent  = wxText(c.weather_code);
      $("wxMeta").textContent  = "UPDATED " + fmtTime12(new Date(c.time));

      $("wxEmpty").style.display = "none";
    }

    // ==========================
    // NEWS (RSS2JSON)
    // ==========================
    async function loadFeeds(feedList){
      const groups = [];
      for(const f of feedList){
        try{
          const data = await fetchJson(rss2jsonUrl(f.url));
          const items = (data.items || []).map(it => ({
            title: it.title || "",
            link: it.link || "",
            pubDate: it.pubDate || it.published || "",
            source: f.name,
            thumbnail: it.thumbnail || "",
            enclosure: it.enclosure || {},
            description: it.description || ""
          })).filter(x => x.title);
          groups.push({ name:f.name, items });
        }catch(e){
          groups.push({ name:f.name, items: [] });
        }
      }
      return groups;
    }

    function mergeAndSort(groups){
      const all = [];
      groups.forEach(g => g.items.forEach(x => all.push(x)));
      all.sort((a,b) => (Date.parse(b.pubDate||"")||0) - (Date.parse(a.pubDate||"")||0));
      const seen = new Set();
      const out = [];
      for(const x of all){
        const key = (x.title||"").toLowerCase();
        if(!key || seen.has(key)) continue;
        seen.add(key);
        out.push(x);
      }
      return out;
    }

    // ==========================
    // HERO / BREAKING / TICKER
    // ==========================
    function setBreakingBar(items){
      const bar = $("breakingBar");
      const track = $("breakingTrack");
      if(!items || !items.length){
        bar.classList.remove("on");
        return;
      }
      bar.classList.add("on");

      const parts = items.slice(0, 6).map(x => x.title).filter(Boolean);
      const html = parts.map(t => `<span>${escapeHtml(t)}</span>`).join(`<span class="breakingSep"> • </span>`);
      // Duplicate for seamless loop
      track.innerHTML = (html || "<span>BREAKING</span>") + `<span class="breakingSep"> • </span>` + (html || "<span>BREAKING</span>");
    }

    function setTicker(){
      const track = $("tickerTrack");
      const worldTop = worldItems[0]?.title || "—";
      const localTop = localItems[0]?.title || "—";
      const wx = ($("wxDesc").textContent || "—") + " " + ($("wxTemp").textContent || "--") + "°";

      const parts = [];
      if(breakingItems.length){
        parts.push("BREAKING: " + breakingItems[0].title);
      }
      parts.push("WORLD: " + worldTop);
      parts.push("LOCAL: " + localTop);
      parts.push("WEATHER: " + wx);
      parts.push("MARKETS: SPX500 • US30 • NAS100 • TSX");

      const html = parts.map(p => `<span>${escapeHtml(p)}</span>`).join(`<span class="tickSep"> • </span>`);
      const fallback = `<span class="tickMuted">LIVE • NEWS • MARKETS • WEATHER</span>`;
      track.innerHTML = (html || fallback) + `<span class="tickSep"> • </span>` + (html || fallback);
    }

    function setHeroFrom(item, sectionLabel){
      const title = item?.title || "—";
      const link  = item?.link || "#";
      const when  = item?.pubDate ? timeAgo(item.pubDate) : "—";
      const source= item?.source || "TOP STORY";
      const img   = bestImage(item);
      const desc  = stripHtml(item?.description || "");
      const deck  = desc ? desc : "Tap OPEN STORY to read more.";

      $("heroTitle").textContent = title;
      $("heroDeck").textContent = deck;
      $("heroSource").textContent = source.toUpperCase();
      $("heroSection").textContent = sectionLabel.toUpperCase();
      $("heroAge").textContent = when ? when.toUpperCase() : "—";
      $("heroLink").href = link;
      $("heroUpdated").textContent = "UPDATED " + fmtTime12(new Date());

      const isBreaking = item && isBreakingItem(item);
      $("heroBreaking").style.display = isBreaking ? "" : "none";

      const imgEl = $("heroImg");
      if(img){
        imgEl.onload = () => { imgEl.style.display = ""; };
        imgEl.onerror = () => { imgEl.style.display = "none"; imgEl.removeAttribute("src"); };
        imgEl.src = img;
      } else {
        imgEl.style.display = "none";
        imgEl.removeAttribute("src");
      }
    }

    function rotateHero(){
      const pool = (heroMode === "world") ? worldItems : localItems;
      const label = (heroMode === "world") ? "World" : "Local";

      if(pool && pool.length){
        const idx = heroIndex % pool.length;
        setHeroFrom(pool[idx], label);
        heroIndex++;
      } else {
        // fallback
        setHeroFrom({ title:"Waiting for headlines…", source:"SYSTEM", description:"" }, label);
      }

      // alternate modes so it feels like a channel
      heroMode = (heroMode === "world") ? "local" : "world";
    }

    // ==========================
    // MARKETS (TradingView embed)
    // ==========================
    function initTradingView(){
      const mount = $("tv_widget");
      mount.innerHTML = "";

      const payload = {
        "symbols": MARKET_SYMBOLS,
        "chartOnly": false,
        "width": "100%",
        "height": "100%",
        "locale": "en",
        "colorTheme": "dark",
        "autosize": true,
        "showVolume": false,
        "showMA": false,
        "hideDateRanges": false,
        "hideMarketStatus": false,
        "hideSymbolLogo": false,
        "scalePosition": "right",
        "scaleMode": "Normal",
        "fontFamily": "-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif",
        "fontSize": "12",
        "noTimeScale": false,
        "valuesTracking": "1",
        "changeMode": "price-and-percent",
        "chartType": "area",
        "dateRanges": ["1D|1","1M|30","3M|60","12M|1D"]
      };

      const s = document.createElement("script");
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js";
      s.text = JSON.stringify(payload);
      mount.appendChild(s);
    }

    // ==========================
    // REFRESH LOOP
    // ==========================
    async function refreshAll(){
      const started = Date.now();
      $("updated").textContent = "UPDATING…";

      $("place").textContent = LOCATION.label;

      // Weather
      await loadWeather().catch(() => {
        $("wxMeta").textContent = "NO DATA";
        $("wxDesc").textContent = "UNAVAILABLE";
        $("wxEmpty").style.display = "";
        $("wxEmpty").textContent = "Weather failed to load.";
      });

      // News
      const [worldGroups, localGroups] = await Promise.all([
        loadFeeds(FEEDS.world),
        loadFeeds(FEEDS.local)
      ]);

      worldItems = mergeAndSort(worldGroups);
      localItems = mergeAndSort(localGroups);

      // Breaking candidates from both pools (recent)
      const combined = [...worldItems.slice(0, 20), ...localItems.slice(0, 20)];
      breakingItems = combined.filter(isBreakingItem).slice(0, 8);

      // Render lists
      if(worldItems.length){
        $("worldMeta").textContent = worldItems.length + " ITEMS";
        setEmpty("world", "");
        renderList("worldList", worldItems, 10);
      } else {
        $("worldMeta").textContent = "NO DATA";
        setEmpty("world", "World news failed. Check RSS2JSON key / network.");
      }

      if(localItems.length){
        $("localMeta").textContent = localItems.length + " ITEMS";
        setEmpty("local", "");
        renderList("localList", localItems, 10);

        $("mixMeta").textContent = Math.min(14, localItems.length) + " ITEMS";
        setEmpty("mix", "");
        renderList("mixList", localItems, 14);
      } else {
        $("localMeta").textContent = "NO DATA";
        $("mixMeta").textContent = "NO DATA";
        setEmpty("local", "Local news failed. Check RSS2JSON key / network.");
        setEmpty("mix", "Local news failed (see Local panel).");
      }

      // Bars & ticker
      setBreakingBar(breakingItems);
      setTicker();

      // Update hero immediately using top story
      const topWorld = worldItems[0];
      const topLocal = localItems[0];

      // Prefer breaking if present, then world, then local
      const heroPick = breakingItems[0] || topWorld || topLocal;
      const heroLabel = breakingItems[0] ? "Breaking" : (topWorld ? "World" : "Local");
      setHeroFrom(heroPick || {title:"No headlines", source:"SYSTEM"}, heroLabel);

      const took = Math.max(1, Math.round((Date.now() - started)/1000));
      $("updated").textContent = "UPDATED " + fmtTime12(new Date()) + " • " + took + "s";

      nextRefreshAt = Date.now() + REFRESH_MS;
      tickCountdown();
    }

    function start(){
      // Initial UI ticks
      tickClock(); setInterval(tickClock, 1000);
      tickCountdown(); setInterval(tickCountdown, 1000);

      // Rotate countdown + rotate hero
      $("rotIn").textContent = String(rotateIn);
      setInterval(() => {
        rotateIn -= 1;
        if(rotateIn <= 0){
          rotateHero();
          rotateIn = ROTATE_S;
        }
        $("rotIn").textContent = String(rotateIn);
      }, 1000);

      // Markets
      initTradingView();

      // Initial load + refresh schedule
      refreshAll().catch(() => { $("updated").textContent = "UPDATE FAILED"; });
      setInterval(() => { refreshAll().catch(() => {}); }, REFRESH_MS);
    }

    document.addEventListener("DOMContentLoaded", start);
  </script>
</body>
</html>
