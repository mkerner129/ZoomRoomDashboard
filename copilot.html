<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live 1-Day Market Chart with Ticker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    background: #f5f5f5;
    font-family: Arial, sans-serif;
    padding: 20px;
  }
  .chart-container {
    width: 100%;
    max-width: 800px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .ticker {
    text-align: center;
    font-size: 1.4em;
    font-weight: bold;
    margin-bottom: 15px;
  }
  .up {
    color: #16a34a; /* green */
  }
  .down {
    color: #dc2626; /* red */
  }
</style>
</head>
<body>

<div class="chart-container">
  <div id="ticker" class="ticker">Loading...</div>
  <canvas id="marketChart"></canvas>
</div>

<script>
let marketChart; // Store chart instance

async function fetchMarketData() {
    const response = await fetch(
        'https://query1.finance.yahoo.com/v8/finance/chart/^GSPC?interval=5m&range=1d'
    );
    const json = await response.json();

    const result = json.chart.result[0];
    const timestamps = result.timestamp;
    const prices = result.indicators.quote[0].close;

    // Convert UNIX timestamps to readable times
    const labels = timestamps.map(ts => {
        const date = new Date(ts * 1000);
        return date.getHours() + ':' + String(date.getMinutes()).padStart(2, '0');
    });

    // Get latest and opening prices for ticker
    const latestPrice = prices[prices.length - 1];
    const openingPrice = prices.find(p => p !== null); // first non-null
    const change = latestPrice - openingPrice;
    const changePercent = (change / openingPrice) * 100;

    return { labels, prices, latestPrice, change, changePercent };
}

async function renderChart() {
    const { labels, prices, latestPrice, change, changePercent } = await fetchMarketData();

    // Update ticker
    const tickerEl = document.getElementById('ticker');
    const sign = change >= 0 ? '+' : '';
    tickerEl.innerHTML = `S&P 500: ${latestPrice.toFixed(2)} <span class="${change >= 0 ? 'up' : 'down'}">(${sign}${change.toFixed(2)}, ${sign}${changePercent.toFixed(2)}%)</span>`;

    const ctx = document.getElementById('marketChart').getContext('2d');

    if (!marketChart) {
        // Create chart first time
        marketChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'S&P 500',
                    data: prices,
                    borderColor: '#0078d4',
                    backgroundColor: 'rgba(0,120,212,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { color: '#eee' } }
                }
            }
        });
    } else {
        // Update chart data
        marketChart.data.labels = labels;
        marketChart.data.datasets[0].data = prices;
        marketChart.update();
    }
}

// Initial render
renderChart();

// Auto-refresh every 60 seconds
setInterval(renderChart, 60000);
</script>

</body>
</html>
